<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Offline Email with Isync | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Offline Email with Isync</span></h1><div class=post-meta><span> Published on 11 Nov 2023</span>
<span class=seperator>.</span>
<span> Filed in <a href=/notes>Notes</a></span>
<span class=seperator>.</span>
<span> 796 words</span></div></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Isync</h2><div id=outline-text-headline-1 class=outline-text-2><p>Install <code>isync</code> using your package manager, here we are installing the <code class=verbatim>apt</code> package manager, but use whatever package manager you are using:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt install isync</span></span></code></pre></div></div><p>We will use <code>isync</code> program to download mails to local Maildir folder. We can also use a program called <code>offlineimap</code> which is a bit slower but it can work on Windows.</p><p><strong>NOTE: isync is the name of the project, mbsync is the name of the executable.</strong></p><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Isync Configuration</h3><div id=outline-text-headline-2 class=outline-text-3><p>Download mails from remote Maildir folder using <code class=verbatim>.mbsyncrc</code> configuration file with following settings.</p><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>Remote Maildir</h4><div id=outline-text-headline-3 class=outline-text-4><p>Arbitrary name to remote mail server:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>### This file is generated by Emacs&#39;s &#34;org-bable-tangle&#34; function
</span></span><span style=display:flex><span>## Gmail - vithurshan@laposte.net
</span></span><span style=display:flex><span>IMAPAccount laposte</span></span></code></pre></div></div><p>Imap server to download mails from:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>Host imap.laposte.net</span></span></code></pre></div></div><p>ID or mail address to connect to IMAP server:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>User vithurshan@laposte.net</span></span></code></pre></div></div><p>Do not use clear text password <code class=verbatim>Pass yourPassword</code>. To store the password in an encrypted file use <code class=verbatim>PassCmd "gpg -q --for-your-eyes-only --no-tty -d ~/.mailpass.gpg"</code>. Or use password manager Pass using:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>PassCmd &#34;/usr/bin/pass mail/laposte | head -n 1&#34;</span></span></code></pre></div></div><p>Use SSL with IMAP protocol:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>SSLType IMAPS</span></span></code></pre></div></div><p>We can also set <code class=verbatim>SSLVersions</code> to use and the value is depends on the output of:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  openssl s_client -connect imap.gmail.com:993 -showcerts | grep Protocol</span></span></code></pre></div></div><p>The following line should work. If you get certificate errors, uncomment the two following lines and read the "Troubleshooting" section at <a href=https://wiki.archlinux.org/title/isync#Troubleshooting:>https://wiki.archlinux.org/title/isync#Troubleshooting:</a></p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>CertificateFile /etc/ssl/certs<span style=font-style:italic>/ca-certificates.crt
</span></span></span><span style=display:flex><span><span style=font-style:italic>#CertificateFile ~/</span>.cert<span style=font-style:italic>/imap.gmail.com.pem
</span></span></span><span style=display:flex><span><span style=font-style:italic>#CertificateFile ~/</span>.cert/Equifax_Secure_CA.pem</span></span></code></pre></div></div></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>Remote Maildir as IMAPStore</h4><div id=outline-text-headline-4 class=outline-text-4><p>Here we assign the remote maildir as IMAPStore:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>IMAPStore laposte-remote
</span></span><span style=display:flex><span>Account laposte</span></span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>Local Maildir</h4><div id=outline-text-headline-5 class=outline-text-4><p>Let's now configure local maildir location for storing mails locally by setting a arbitrary name for the section:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>MaildirStore laposte-local</span></span></code></pre></div></div><p>This replicates the hierarchy of subfolders on remote server to local maildir if there are any under the inbox:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>SubFolders Verbatim</span></span></code></pre></div></div><p>The path to store downloaded mail. The trailing "/" is important:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>Path ~/.local/share/mail<span style=font-style:italic>/vithurshan@laposte.net/</span>
</span></span><span style=display:flex><span>Inbox ~/.local/share/mail/vithurshan@laposte.net/Inbox</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-4><h4 id=headline-6>Mails Sync Config</h4><div id=outline-text-headline-6 class=outline-text-4><p>Associate mailboxes that we created earlier, local and remote, namely <code class=verbatim>laposte-remote</code> and <code class=verbatim>laposte-local:</code></p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>Channel laposte
</span></span><span style=display:flex><span>Far :laposte-remote:
</span></span><span style=display:flex><span>Near :laposte-local:</span></span></code></pre></div></div><p>The following configuration tells what and how to sync the local maildir with remote one.
We can exclude everything under [Gmail] folder, except the interesting folders:</p><div class="src src-:tangle"><pre tabindex=0><code class=language-:tangle data-lang=:tangle>Patterns * ![Gmail]* &#34;[Gmail]/Sent Mail&#34; &#34;[Gmail]/Starred&#34; &#34;[Gmail]/All Mail&#34;</code></pre></div><p>Some older accounts name <code class=verbatim>Bin</code> as <code class=verbatim>Trash</code>, and if the names of the remote folders are not mentioned correctly in the configuration file, then it will causes an error. Or if your Gmail is set up with a different lanugage, then you need to translate the names of these folders. For Norwegian <code class=verbatim>[Gmail]/Corbeille</code> would be <code class=verbatim>[Gmail]/Papirkurv</code>. We can view the names of remote folders:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  mbsync -c ~/.emacs.d/mu4e/.mbsyncrc -Dmn acc1-gmail</span></span></code></pre></div></div><p>Or include everything:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>Patterns *</span></span></code></pre></div></div><p>Automatically create missing mailboxes, both locally and on the server. For ex: if we create a folder in the remote or local maildir, the next time <code class=verbatim>mbsync</code> run it won't create the folder:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>Create Both</span></span></code></pre></div></div><p>Sync the movement of messages between folders and deletions, add after making sure the sync works:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>Expunge Both</span></span></code></pre></div></div><p>Save the synchronization state files in the relevant directory (in local mailbox folder). For example if we move all of downloaded mails another location on the disk and the next time we run mbsync, it will read default sync state file and assume that we delete all mails and make that change to remote repo.</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>SyncState *</span></span></code></pre></div></div></div></div><div id=outline-container-headline-7 class=outline-4><h4 id=headline-7>Additional Mail Account [Optional]</h4><div id=outline-text-headline-7 class=outline-text-4><p>We can download emails from as many remote locations as we want, here is a full Isync config of another IMAP server to download mails from:</p><div class="src src-org"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span>## Gmail - vithurshanselvarajah@gmail.com
</span></span><span style=display:flex><span>IMAPAccount gmail
</span></span><span style=display:flex><span>Host imap.gmail.com
</span></span><span style=display:flex><span>User vithurshanselvarajah@gmail.com
</span></span><span style=display:flex><span>PassCmd &#34;cat ~/lab/emacs/mu4e/password&#34;
</span></span><span style=display:flex><span>SSLType IMAPS
</span></span><span style=display:flex><span>CertificateFile /etc/ssl/certs<span style=font-style:italic>/ca-certificates.crt
</span></span></span><span style=display:flex><span><span style=font-style:italic>
</span></span></span><span style=display:flex><span><span style=font-style:italic>IMAPStore gmail-remote
</span></span></span><span style=display:flex><span><span style=font-style:italic>Account gmail
</span></span></span><span style=display:flex><span><span style=font-style:italic>
</span></span></span><span style=display:flex><span><span style=font-style:italic>MaildirStore gmail-local
</span></span></span><span style=display:flex><span><span style=font-style:italic>Subfolders Verbatim
</span></span></span><span style=display:flex><span><span style=font-style:italic>Path ~/</span>.local/share/mail<span style=font-style:italic>/vithurshanselvarajah@gmail.com/</span>
</span></span><span style=display:flex><span>Inbox ~/.local/share/mail/vithurshanselvarajah@gmail.com/Inbox
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Channel gmail
</span></span><span style=display:flex><span>Far :gmail-remote:
</span></span><span style=display:flex><span>Near :gmail-local:
</span></span><span style=display:flex><span>Patterns * ![Gmail]* &#34;[Gmail]/Messages envoy&amp;AOk-s&#34; &#34;[Gmail]/Suivis&#34; &#34;[Gmail]/Tous les messages&#34; &#34;[Gmail]/Corbeille&#34; &#34;[Gmail]/Brouillons&#34;
</span></span><span style=display:flex><span>Create Both
</span></span><span style=display:flex><span>SyncState *</span></span></code></pre></div></div><p><strong>NOTE: Be careful of how you manage whitespace between lines in this file, the spaces define groupings!</strong></p><p><strong>NOTE: mbsync won’t create the base maildir for you, you’ll have to create it: ~/.local/share/mail/vithurshanselvarajah@gmail.com/</strong></p></div></div></div></div><div id=outline-container-headline-8 class=outline-3><h3 id=headline-8>Start synchronization</h3><div id=outline-text-headline-8 class=outline-text-3><p>Once we have put all the configuration in <code class=verbatim>mbsyncrc</code> file and created the folder <code class=verbatim>~/.local/share/mail/vithurshan@laposte.net/</code> to store the remote maildir locally, we are ready to download:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  mbsync -c ~/.dotfiles/.config/isync/mbsyncrc -a</span></span></code></pre></div></div><div id=outline-container-headline-9 class=outline-4><h4 id=headline-9>Automatic Sync [Optional]</h4><div id=outline-text-headline-9 class=outline-text-4><p>We can automate the synchronisation of mailboxes using Systemd. Let's first a create a Systemd service file <code class=verbatim>~/.config/systemd/user/mbsync.service</code> that launches the sync:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Description=Mailbox synchronization service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Type=oneshot
</span></span><span style=display:flex><span>ExecStart=/usr/bin/mbsync -Va -c /path/to/mbsyncrc -a
</span></span><span style=display:flex><span>Environment=&#34;DISPLAY=:0&#34;
</span></span><span style=display:flex><span># Environment=&#34;XAUTHORITY=/path/to/.Xauthority&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=default.target</span></span></code></pre></div></div><p><strong>NOTE: Make sure to change the value <code class=verbatim>/path/to/mbsyncrc</code> to Isync's configuration file that we created <a href="Isync Configuration">above</a>.</strong></p><p>Then creating <code class=verbatim>~/.config/systemd/user/mbsync.timer</code> file which configures mbsync to be started 2 minutes after boot, and then every 5 minutes:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Description=Mailbox synchronization timer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Timer]
</span></span><span style=display:flex><span>OnBootSec=2m
</span></span><span style=display:flex><span>OnUnitActiveSec=5m
</span></span><span style=display:flex><span>Unit=mbsync.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=timers.target</span></span></code></pre></div></div><p>Once those two files are created, reload systemd, then enable and start <code class=verbatim>mbsync.timer</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  systemctl --user daemon-reload <span style=color:#f92672>&amp;&amp;</span> systemctl --user enable --now mbsync.timer</span></span></code></pre></div></div></div></div></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>