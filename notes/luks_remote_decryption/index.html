<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Déchiffrement à distance de Luks | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Déchiffrement à distance de Luks</span></h1><h2 class=date>2022/09/07</h2></div><main><p>Sous Linux, nous chiffrons nos partitions et l&rsquo;intégralité du disque à l&rsquo;aide de Linux Unified Key Setup-on-disk-format (LUKS) pour la sécurité et la confidentialité. Nous déverrouillons le disque protégé (par LUKS) en fournissant une phrase de passe au démarrage. Donc, pour pouvoir déchiffrer, il faut être devant l&rsquo;ordinateur pour entrer la phrase secrète.</p><p>Nous avons un programme qui résout ce problème en permettant de décrypter les partitions LUKS à distance. Voyons comment déverrouiller la partition LUKS à l&rsquo;aide des clés Dropbear SSH sous Linux au démarrage.</p><blockquote><p><strong>Note :</strong> Veuillez noter que ce guide suppose que vous disposez d&rsquo;une partition /boot distincte qui n&rsquo;est pas chiffrée.</p></blockquote><h2 id=comment-fonctionne-le-déverrouillage-à-distance>Comment fonctionne le déverrouillage à distance</h2><p>Le noyau charge ce qu&rsquo;on appelle l&rsquo;image initramfs. À l&rsquo;intérieur de cette image se trouvent les fichiers,modules et scripts nécessaires pour déchiffrer/monter la partition racine.</p><p>Maintenant, si nous pouvions en quelque sorte exécuter un serveur SSH dans initramfs et le rendre accessible sur le réseau, nous pourrions nous y connecter pour déverrouiller la partition racine à distance.</p><p>Comme initramfs s&rsquo;exécute en mémoire, nous sommes limités en termes de taille de mémoire et de complexité des programmes en cours d&rsquo;exécution. C&rsquo;est la principale raison pour laquelle <a href=https://matt.ucc.asn.au/dropbear/dropbear.html>Dropbear</a> est utilisé comme serveur SSH et <a href=https://busybox.net/>BusyBox</a>, pour fournir un shell et des utilitaires.</p><h2 id=déverrouiller-la-partition-luks-à-distance>Déverrouiller la partition LUKS à distance</h2><p><code>dropbear-initramfs</code> est un package qui installe un serveur SSH léger (dropbear) dans la partition de démarrage (/boot) non chiffrée afin que nous puissions nous connecter à distance et entrer la phrase secrète pour LUKS et continuer le démarrage.</p><p>Installer dropbear-initramfs après avoir mis à jour l&rsquo;index des packages <code>apt</code>. <em>( L&rsquo;index des packages apt est une base de données qui stocke la liste des packages logiciels du repository ) :</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo apt install dropbear-initramfs
</span></span><span style=display:flex><span>dropbear: WARNING: Invalid authorized_keys file, SSH login to initramfs won<span style=color:#960050;background-color:#1e0010>&#39;</span>t work!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ dropbear -V
</span></span><span style=display:flex><span>Dropbear v2020.81
</span></span></code></pre></div><p>Don&rsquo;t worry about that warning. We&rsquo;ll generate our keys a bit later.</p><h3 id=configuration-de-dropbear>Configuration de dropbear</h3><blockquote><p><strong>Note :</strong> Les versions antérieures de dropbear-initramfs stockaient les fichiers de configuration sous <code>/etc/dropbear/initramfs</code>. Dans la version que nous utilisons dans ce tutoriel (v2020.81) a été déplacé vers <code>/etc/dropbear-initramfs</code>. Remplacez le chemin en fonction de votre version installée.</p></blockquote><p>Ouvrez le fichier <code>/etc/dropbear-initramfs/dropbear.conf</code> dans votre éditeur de texte préféré :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo nano /etc/dropbear/initramfs/dropbear.conf
</span></span></code></pre></div><p>Dans ce fichier, vous remarquerez que la ligne <code>DROPBEAR_OPTIONS</code> est commentée. Il n&rsquo;est pas nécessaire de modifier cela, mais nous allons spécifier quelques options. Assurez-vous de décommenter la ligne pour que nos modifications prennent effet :</p><pre tabindex=0><code>DROPBEAR_OPTIONS=&#34;-I 180 -j -k -p 2222 -s&#34;
</code></pre><ol><li><strong>-I 180 :</strong> Déconnecte la session si aucun trafic n&rsquo;est transmis ou reçu en 180 secondes.</li><li><strong>-j :</strong> Désactive le transfert de port local ssh.</li><li><strong>-k :</strong> Désactive également le transfert de port distant.</li><li><strong>-p 2222 :</strong> Changer le port par défaut a savoir 22.</li><li><strong>-s :</strong> Désactiver les connexions par mot de passe. Nous allons mettre en place des clés SSH sur un système Linux/Unix pour l&rsquo;authentification afin de réduire la surface d&rsquo;attaque.</li></ol><p>D&rsquo;autres options sont disponibles et peuvent être trouvées dans les pages de manuel de dropbear : <code>man dropbear</code></p><h2 id=optional-configuring-a-static-ip-with-initramfs>(Optional) Configuring a static IP with initramfs</h2><p>Vous utilisez probablement déjà une adresse IP statique pour vous connecter à votre serveur. Cela peut être configuré sur votre routeur ou le serveur DHCP en utilisant la réservations DHCP ou localement dans la configuration réseau de votre serveurs.</p><p>Si vous avez fait ce dernier, nous devons indiquer à initramfs quelle adresse IP utiliser afin que nous puissions nous y connecter plus tard (sinon DHCP attribuera la prochaine adresse IP disponible dans sa plage).</p><p>Ouvrez le fichier <code>/etc/initramfs-tools/initramfs.conf</code> et en bas nous insèrerons :</p><pre tabindex=0><code>IP=&lt;local-ip&gt;::&lt;gateway-ip&gt;:&lt;subnet-mask&gt;
</code></pre><blockquote><p>Il y a deux deux-points (::) entre l&rsquo;adresse IP et la passerelle. C&rsquo;est parce que nous omettons une option car elle ne s&rsquo;applique pas. Pour plus d&rsquo;informations sur les options disponibles pour IP, consultez la section nfsroot <a href=https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt>ici</a> sous la ligne <code>Kernel command line</code>.</p></blockquote><p>Si vous avez plusieurs interfaces réseau, vous pouvez spécifier l&rsquo;interface à utiliser :</p><pre tabindex=0><code>IP=&lt;local-ip&gt;::&lt;gateway-ip&gt;:&lt;subnet-mask&gt;::&lt;interface&gt;
</code></pre><p>Encore une fois, notez les deux points entre le masque de sous-réseau et l&rsquo;interface. C&rsquo;est parce que nous omettons l&rsquo;option <code>hostname</code>.</p><p>Ex :</p><pre tabindex=0><code>IP=192.168.0.12::192.168.0.254:255.255.255.0::eth0
</code></pre><p>Maintenant que nous avons apporté des modifications à dropbear-initramfs et initramfs, nous devons mettre à jour notre image de démarrage (initramfs) en exécutant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo update-initramfs -u
</span></span></code></pre></div><h2 id=configuration-des-clés-ssh>Configuration des clés SSH</h2><p>Nous avons maintenant configuré le système pour démarrer un serveur dropbear SSH au démarrage (juste avant de demander notre mot de passe LUKS) mais nous n&rsquo;avons aucun moyen d&rsquo;y accéder car nous avons désactivé l&rsquo;authentification par mot de passe. Il faut donc configurer les clés pour pouvoir s&rsquo;authentifier.</p><p>Nous allons générer de nouvelles clés SSH spécifiquement pour une utilisation avec dropbear. Il est recommandé de le faire sur un PC client (la clé privée ne doit pas être transmise) puis de copier la clé publique sur le serveur.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh-keygen -t ed25519 -f ~/.ssh/unlock_dropbear
</span></span></code></pre></div><pre tabindex=0><code>ssh-keygen -t ed25519 -f ~/.ssh/dropbear
Generating public/private ed25519 key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
</code></pre><p>Maintenant que vos clés ont été générées, copions votre clé publique sur le serveur dont vous souhaitez prendre le contrôle a distance afin de chiffrer la partition LUKS :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>scp ~/.ssh/id_dropbear.pub user@192.168.0.12:
</span></span></code></pre></div><blockquote><p><strong>Note :</strong> je n&rsquo;ai pas fourni de chemin après le 192.168.0.12: ce qui signifie que le fichier sera placé dans notre chemin par défaut qui est par défaut notre répertoire personnel <code>/home/user</code>.</p></blockquote><p>Enfin, nous allons nous connecter à notre serveur, ajouter cette clé publique à dropbear et mettre à jour initramfs :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh user@192.168.0.12
</span></span><span style=display:flex><span>cat ~/id_dropbear &gt;&gt; /etc/dropbear/initramfs/authorized_keys
</span></span><span style=display:flex><span>sudo update-initramfs -u
</span></span></code></pre></div><p>Enfin redémarrez le serveur :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo reboot
</span></span></code></pre></div></main><footer><script defer src=//yihui.org/js/math-code.js></script>
<script defer src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script defer src=//yihui.org/js/center-img.js></script><hr>© <a href=https://www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 &ndash; 2023 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>