<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Install FTP Server | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Install FTP Server</span></h1><h2 class=date>2023/07/15</h2></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Introduction</h2><div id=outline-text-headline-1 class=outline-text-2><p>FTP stands for File Transfer Protocol which is used for transferring file between a centralized server and clients over a network. This tutorial describes the installation, configuration and securing process of FTP server. This tutorial uses <code class=verbatim>VSFTPD</code> as a FTP server software which stands Very Secure FTP Daemon.</p><p>The communication between FTP client and server is done by using two type of connection namely control connection and a data connection. Control connection is used to send commands to FTP server such as <code>LIST</code> to list files and folders on the server. Then the server sends the list of files and folders using data connection. The control connection uses port <code class=verbatim>21</code> and the data connection port depends on the mode, namely active and passive.</p><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Active Mode</h3><div id=outline-text-headline-2 class=outline-text-3><p>In active mode, FTP client uses a random unprivileged port (N > 1023) to connect to FTP server on port 21. Then the client starts listening on port N+1 and sends FTP command <code>PORT N+1</code> to the FTP server. The server will connect to listening client port <code>N+1</code> from the local data port <code class=verbatim>20</code></p><p>For example:</p><ol><li>Client uses port <code class=verbatim>1026</code> to connect to server's command port <code class=verbatim>21</code>.</li><li>Send the command <code>PORT 1027</code> to server's command port <code class=verbatim>21</code>.</li><li>Server uses port <code class=verbatim>20</code> to connect to port <code class=verbatim>1027</code>.</li><li>Finally, the client sends an TCP ACK message.</li></ol><p>Start FTP client in debug mode to view connection details when connecting to FTP server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  ftp -d &lt;IP&gt;</span></span></code></pre></div></div><p><strong>NOTE: When using active mode, the client-side firewall must allow the data port the client is listening on. If the client uses NAT, the FTP user needs port redirection.</strong></p></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>Passive Mode</h3><div id=outline-text-headline-3 class=outline-text-3><p>In passive mode, the FTP client initiates a control connection using a random unprivileged port (N > 1023) to server on port 21 and instead of sending <code>PORT N+1</code> command to indicate the port that the client is listening on for incoming data connection, the client will send <code>PASV</code> command to FTP server. Then the server send back a port on which server is listening for incoming data connection.</p><p>For example:</p><ol><li>Client uses port <code class=verbatim>1026</code> to connect to server's command port <code class=verbatim>21</code>.</li><li>Send the command <code>PASV</code> to server.</li><li>The client connects using port <code class=verbatim>1026</code> to port <code class=verbatim>2024</code> sent by the server in response to the <code>PASV</code> command.</li><li>Finally, the server sends an TCP ACK message.</li></ol></div></div></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Configure FTP server</h2><div id=outline-text-headline-4 class=outline-text-2><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>Install FTP Server</h3><div id=outline-text-headline-5 class=outline-text-3><p>First start by installing <code class=verbatim>VSFTPD</code> using your package manager:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo apt install vsftpd</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>Configure FTP Server</h3><div id=outline-text-headline-6 class=outline-text-3><p><code class=verbatim>VSFTPD</code> uses <em>/etc/vsftpd.conf</em> file as main configuration file. So backup this file before modifying it in case we need to restore the default configuration of FTP server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.bak</span></span></code></pre></div></div><p>Now open the configuration file and change (uncomment or add) the value of the following directives:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>anonymous_enable=NO  # Disable  anonymous login
</span></span><span style=display:flex><span>local_enable=YES	# Permit local logins
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dirmessage_enable=YES	# Enable showing of messages when users first enter a new directory
</span></span><span style=display:flex><span>xferlog_enable=YES		# A log file will be maintained detailing uploads and downloads
</span></span><span style=display:flex><span>connect_from_port_20=YES     # Use port 20 (ftp-data) on the server machine for PORT style connections
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen=NO   		        # prevent vsftpd from running in standalone mode
</span></span><span style=display:flex><span>listen_ipv6=YES		# vsftpd will listen on an IPv6 socket instead of an IPv4 one
</span></span><span style=display:flex><span>pam_service_name=vsftpd      # name of the PAM service vsftpd will use
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>write_enable=YES            # Enable FTP commands which change the filesystem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chroot_local_user=YES       # Restrict users to browse only their home directory, otherwise they will have access to the entire filesystem on the server
</span></span><span style=display:flex><span>user_sub_token=$USER        # Variable that holds username in /etc/vsftpd.userlist file
</span></span><span style=display:flex><span>local_root=/home/$USER/ftp  # Replace the home directory of each user in /etc/vsftpd.userlist file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>userlist_enable=YES                  # Allow or deny access to users in a list
</span></span><span style=display:flex><span>userlist_file=/etc/vsftpd.userlist   # List of users to aloow or deny access
</span></span><span style=display:flex><span>userlist_deny=NO                     # Allow only users listed in the above file
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssl_enable=YES                                     # Enable SSL connection
</span></span><span style=display:flex><span>rsa_cert_file=/etc/ssl/private/vsftpd.pem          # SSL certificate
</span></span><span style=display:flex><span>rsa_private_key_file=/etc/ssl/private/vsftpd.pem   # SSL certificate&#39;s private key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>allow_anon_ssl=NO           # Deny anonymous user from using SSL connection
</span></span><span style=display:flex><span>force_local_data_ssl=YES    # Force all non-anonymous logins to use SSL connection for data transfer.
</span></span><span style=display:flex><span>force_local_logins_ssl=YES  # Use ssl connection during logins
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssl_tlsv1=YES               # Use TLS instead of SSL because SSL is more secure
</span></span><span style=display:flex><span>ssl_sslv2=NO                # Deny SSL version 2
</span></span><span style=display:flex><span>ssl_sslv3=NO                # Deny SSL version 3
</span></span><span style=display:flex><span>require_ssl_reuse=NO        # All data connection need to prove that they know the same master secret as the control connection 
</span></span><span style=display:flex><span>ssl_ciphers=HIGH            # SSL ciphers to use for encrypted connection
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pasv_enable=YES             # Enable passive mode
</span></span><span style=display:flex><span>pasv_min_port=10091         # Port range to use in passive mode
</span></span><span style=display:flex><span>pasv_max_port=10095         # Port range to use in passive mode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pasv_addr_resolve=YES              # IP address of the host where the data is located, which will be sent to the FTP client in passive mode in response to the PASV command 
</span></span><span style=display:flex><span>pasv_address=&lt;your-domain-name&gt;    # FQDN of data host which will be resolved by above line before sending to FTP client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen_port=&lt;port&gt;           # All FTP requests and responses are logged
</span></span><span style=display:flex><span>log_ftp_protocol=YES         # Listen on XXXX for incoming FTP connections. Default to port 21 if not specified</span></span></code></pre></div></div></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>Generate SSL certificate</h3><div id=outline-text-headline-7 class=outline-text-3><p>We have enabled SSL in our configuration file but have not yet created an SSL certificate:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo openssl req -x509 -nodes -keyout /etc/ssl/private/vsftpd.pem -out /etc/ssl/private/vsftpd.pem -days <span style=color:#ae81ff>365</span> -newkey rsa:2048</span></span></code></pre></div></div><ul><li><code>req</code> – Create a Certificate Signing Request (CSR).</li><li><code>-x509</code> – Certificate format.</li><li><code>-days</code> – Period of validity of the certificate.</li><li><code>-newkey</code> – Create a new private key.</li><li><code>-rsa:2048</code> – 2048 bit length private key.</li><li><code>-keyout</code> – Key file storage location.</li><li><code>-out</code> – Certificate storage location (<strong>NOTE: both certificate and key are stored in the same file: /etc/ssl/private/vsftpd.pem</strong>)</li></ul></div></div><div id=outline-container-headline-8 class=outline-3><h3 id=headline-8>Create an FTP user</h3><div id=outline-text-headline-8 class=outline-text-3><p>Now create an FTP user on the server which will be used by the FTP client to authenticate to the FTP server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo useradd -m ftpuser</span></span></code></pre></div></div><ul><li><code class=verbatim>-m</code> Create a home directory for FTP user <code class=verbatim>ftpuser</code>.</li></ul><p>Then add the newly created user to <em>/etc/vsftpd.userlist</em> file in order to allow FTP access to that user:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo su -c <span style=color:#e6db74>&#34;echo &#39;ftpuser&#39; &gt;&gt; /etc/vsftpd.userlist&#34;</span></span></span></code></pre></div></div><p>And also don't forget to <a href=../change_users_default_shell>disable login access</a> to <code class=verbatim>ftpuser</code>, which will prevent <code class=verbatim>ftpuser</code> from getting an interactive shell.</p></div></div><div id=outline-container-headline-9 class=outline-3><h3 id=headline-9>Chroot FTP Users</h3><div id=outline-text-headline-9 class=outline-text-3><p>We have placed authorized users in a chroot jail, which means the authorized user cannot access directories/files outside of their home directory. But when the <code>chroot_local_user</code> directive value is set to <code>YES</code>, the <code>write_enable</code> directive will not work because the chroot denies writing access. We can enable writing access by setting <code>allowed_writeable_chroot</code> directive's value to <code>YES</code> but it can lead to <a href=https://unix.stackexchange.com/questions/323711/what-are-the-dangers-of-having-writable-chroot-directory-for-ftp/332571#332571>Roaring Beast attack</a>.</p><p>We need to create a new home directory for the FTP user to allow write access and at the same time avoid the previously mentioned security issues:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  mkdir /home/ftpuser/ftp
</span></span><span style=display:flex><span>  chown nobody:nogroup /home/ftpuser/ftp
</span></span><span style=display:flex><span>  chmod a-w /home/ftpuser/ftp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mkdir /home/ftpuser/ftp/files
</span></span><span style=display:flex><span>  chown ftpuser:ftpuser  /home/ftpuser/ftp/files
</span></span><span style=display:flex><span>  chmod <span style=color:#ae81ff>0700</span> /home/ftpuser/ftp/files/</span></span></code></pre></div></div></div></div><div id=outline-container-headline-10 class=outline-3><h3 id=headline-10>Apply Changes</h3><div id=outline-text-headline-10 class=outline-text-3><p>Before applying changes to FTP server by restarting, check the above configuration file for any errors:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo /usr/sbin/vsftpd /etc/vsftpd.conf</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-11 class=outline-2><h2 id=headline-11>References</h2><div id=outline-text-headline-11 class=outline-text-2><ol><li><a href=https://www.tecmint.com/install-ftp-server-in-centos-7/>How to Install, Configure and Secure FTP Server</a></li><li><a href=https://www.tecmint.com/secure-vsftpd-using-ssl-tls-on-centos/>Secure a FTP Server Using SSL/TLS</a></li><li><a href=https://adamtheautomator.com/vsftpd/>Setup FTP Server with VSFTPD</a></li><li><a href=https://www.linuxfordevices.com/tutorials/ubuntu/connecting-ftps-on-ubuntu>Connect Over FTPS</a></li><li><a href=https://sysreseau.net/fonctionnement-du-protocole-ftp-mode-passive-et-active/>Mode passive et active</a></li><li><a href=https://slacksite.com/other/ftp.html>Active FTP vs. Passive FTP</a></li></ol></div></div></main><footer><hr>© <a href=https://www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 &ndash; 2023 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>