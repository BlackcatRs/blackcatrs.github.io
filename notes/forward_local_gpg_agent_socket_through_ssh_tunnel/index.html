<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Forward Local GPG Agent Socket through SSH Tunnel | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Forward Local GPG Agent Socket through SSH Tunnel</span></h1><h2 class=date>2022/09/07</h2></div><main><h1 id=table-of-contents>Table of Contents</h1><ul><li><a href=#introduction>Introduction</a></li><li><a href=#configure-ssh-server>Configure SSH Server</a></li><li><a href=#forward-local-gpg-agent-socket>Forward Local GPG Agent Socket</a></li><li><a href=#gpg-agent-command>GPG Agent Command</a></li><li><a href=#debug-socket-forwarding>Debug Socket Forwarding</a></li><li><a href=#references>References</a></li></ul><h1 id=introduction>Introduction</h1><p><code>gpg-agent</code> is a daemon used to manage GPG secret (private) keys for the <code>gpg</code> and <code>gpgsm</code> programs. These programs interact with the <code>gpg-agent</code> daemon through a socket to request the secret key and request for the secret key.</p><p>If the gpg-agent process has the key, it provides it to gpg. If not, it tries to load the encrypted key from your keyring and prompts you for the key&rsquo;s passphrase. Once the agent has obtained the decrypted key, it will store in memory. Then it passes it to the GPG process. In addition to GPG secret keys, Gpg-agent can also store SSH keys and provide them to SSH processes, like the <code>ssh-agent</code> program that comes with SSH.</p><p>There are 2 sockets through which programs like <code>gpg</code> and <code>gpgsm</code> communicates in order to retrieve secret keys. First <code>agent-socket</code> is used by local process to communicate with gpg-agent and the second one is <code>agent-extra-socket</code> which is a more restricted socket can be used by remote machine in case of socket forwarding.</p><p>GPG v2.1 enables you to forward the gpg-agent to a remote system. That means that you can keep your secret keys on a local machine.</p><p><strong>You need at least GnuPG 2.1.1 on both systems.</strong></p><h1 id=configure-ssh-server>Configure SSH Server</h1><p>We first need to configure SSH server on remote machine to enable automatic removal of stale sockets when connecting (or forwarding GPG socket) to the remote machine. Otherwise you will first have to remove the existing socket on the remote machine before forwarding works.</p><p>This can be automated by adding the following line to <code>/etc/ssh/sshd_config</code> file:</p><pre tabindex=0><code>StreamLocalBindUnlink yes
</code></pre><h1 id=forward-local-gpg-agent-socket>Forward Local GPG Agent Socket</h1><p>Let&rsquo;s say the remote machine needs an SSH key stored on our local machine in the GPG keyring in order to sign a commit before pushing to Git.</p><p>So we forward gpg-agent socket which is located at <code>/run/user/1000/gnupg/S.gpg-agent</code> to remote machine through SSH tunnel using <code>-R</code> option which can forward any type of gpg-agent socket and remote machine uses the forwarded socket instead of local one. So the remote machine will interact with our forwarded gpg-agent which contain secret keys.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh -R &lt;remote socket path&gt;:&lt;local socket path&gt; hostname
</span></span></code></pre></div><p>We can find the location of GPG socket using the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gpgconf --list-dir agent-socket
</span></span></code></pre></div><p>Then replace the default SSH socket used by the SSH program to retrieve SSH keys by the forwarded GPG Agent socket:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export SSH_AUTH_SOCK<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>gpgconf --list-dirs agent-ssh-socket<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>GPG agent tries to load the encrypted key from your local GPG keyring using forwarded socket and prompts you for the key&rsquo;s passphrase if the key is protected. Once the agent has obtained the decrypted key, it will store in memory. Then it passes it to the SSH program.</p><p>Since the ssh-agent protocol does not contain a mechanism for telling the GPG agent on which display/terminal it is running, gpg-agent’s ssh-support will use the TTY or X display where gpg-agent has been started. So to update the display to the current one add the following line in your <code>.bashrc</code> file or whatever initialization file is used for all shell invocations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export GPG_TTY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>tty<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>gpg-connect-agent updatestartuptty /bye &gt;/dev/null
</span></span></code></pre></div><p><code>gpg-agent</code> configuration options can be define in <code>.gnupg/gpg-agent.conf</code> file for permanent application. For example if we wants to decrypt a GPG secret key from a shell then we need to use a terminal based pinentry program. This can be changed by adding the <code>pinentry-program /usr/bin/pinentry-tty</code> to gpg-agent configuration file. Also make sure that <code>pinentry-tty</code> program exist on your system, if not install it using your package manager.</p><p>Here are some other options often used:</p><pre tabindex=0><code># Enable gpg-agent to manage keys instead of ssh-agent by SSH client
enable-ssh-support
    
# Change default pinentry program
# pinentry-program /usr/bin/pinentry-qt

# Set the time a cache entry is valid to n seconds.
default-cache-ttl 3600

# SSH password cache time
default-cache-ttl-ssh 3600
max-cache-ttl-ssh 3600
</code></pre><p>A full list of gpg-agent configuration options can be found <a href=https://www.gnupg.org/documentation/manuals/gnupg/Agent-Options.html>here</a>.</p><h1 id=gpg-agent-command>GPG Agent Command</h1><p>The gpg-agent is automatically started on demand by <code>gpg</code>, <code>gpgsm</code>, <code>gpgconf</code>, or <code>gpg-connect-agent</code> and there is no reason to start it manually. But we can start it using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gpg-connect-agent /bye
</span></span><span style=display:flex><span><span style=color:#75715e># OR</span>
</span></span><span style=display:flex><span>gpgconf --launch gpg-agent
</span></span></code></pre></div><p>Reload gpg-agent:</p><pre tabindex=0><code>gpg-connect-agent reloadagent /bye
</code></pre><p>You can manually terminate the currently-running gpg-agent:</p><pre tabindex=0><code>gpgconf --kill gpg-agent
</code></pre><h1 id=debug-socket-forwarding>Debug Socket Forwarding</h1><p>When connecting to a remote machine, we can use the <code>-v</code> option to display information about the forwarding socket:</p><pre tabindex=0><code>ssh -v -R &lt;remote socket path&gt;:&lt;local socket path&gt; hostname
</code></pre><p>Sometimes on a remote machine we need to delete the socket created by remote gpg-agent. This happens when the remote gpg-agent is started or restarted after forwarding the local gpg-agent through the SSH tunnel.</p><h1 id=references>References</h1><p><a href=https://wiki.gnupg.org/AgentForwarding>https://wiki.gnupg.org/AgentForwarding</a></p><p>How does GPG agent work? - <a href=https://unix.stackexchange.com/questions/188668/how-does-gpg-agent-work>https://unix.stackexchange.com/questions/188668/how-does-gpg-agent-work</a></p></main><footer><hr>© <a href=https://www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 &ndash; 2023 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>