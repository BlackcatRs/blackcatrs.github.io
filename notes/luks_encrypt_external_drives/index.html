<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Encrypt external drives with Linux Unified Key Setup (LUKS) | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Encrypt external drives with Linux Unified Key Setup (LUKS)</span></h1><h2 class=date>2024/01/02</h2></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>1. Find your drive</h2><div id=outline-text-headline-1 class=outline-text-2><p>In order to find the correct drive to encrypt, run the <code>lsblk</code> command, then plug in your external storage device and run the <code>lsblk</code> command again. And now by comparing you can identify a new one appeared in the output of the last executed command.</p><p>The <code class=verbatim>/dev/sdX</code> drive referenced in this article is an imaginary device and be sure to replace it with your real device.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>2. Erase the drive [Optional]</h2><div id=outline-text-headline-2 class=outline-text-2><p>Destroy the drive's partition table by overwriting the drive's head with zeros:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/dev/sdX count<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span></span></span></code></pre></div></div><p>We can also overwrite previously stored data to permanently delete them but this is not necessary:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  shred -v --iterations<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> /dev/sdX</span></span></code></pre></div></div></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>3. Create a LUKS-Encrypted Partition on the Drive</h2><div id=outline-text-headline-3 class=outline-text-2><p>Install the <code class=verbatim>cryptsetup</code> utility used to manage LUKS encrypted volumes:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo pacman -S cryptsetup</span></span></code></pre></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>3.1 Encryption and Decryption with Passphrase</h3><div id=outline-text-headline-4 class=outline-text-3><p>Initialize the device as a LUKS partition and set the passphrase with the <code class=verbatim>luksFormat</code> subcommand:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cryptsetup luksFormat /dev/sdX</span></span></code></pre></div></div><p>This will warn you about data overwriting and prompt you for a passphrase for the partition. Finally confirm the passphrase definition with the command <code>cryptsetup luksDump /dev/sdX</code>.</p><p>In order to use the encrypted partition we need to decrypt and open it:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  cryptsetup open /dev/sdX luks_part</span></span></code></pre></div></div><ul><li><code class=verbatim>luks_part</code> An arbitrary name to identify the opened partition.</li></ul><p>LUKS volumes are opened in a special device location called <code class=verbatim>/dev/mapper</code> and when we close the volume using the following command it will be removed from the previous location:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  cryptsetup close luks_part</span></span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>3.1 Encryption and Decryption with Key File</h3><div id=outline-text-headline-5 class=outline-text-3><p>We can also a key file instead of a passphrase to decrypt the partition which allows automount the partition on boot. In order to do so, create a key file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/random of<span style=color:#f92672>=</span>/root/.luks_keys/luks_part bs<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span></span></span></code></pre></div></div><p><em>Note: We instructed <code class=verbatim>dd</code> to read and write 1 block of 512 bytes of size random numbers using the <code class=verbatim>bs</code> and <code class=verbatim>count</code> options respectively.</em></p><p>We can also check the content of the key using the command <code class=verbatim>sudo xxd /root/.luks_keys/luks_part</code>.</p><p>Restrict access to the key file to enhance security. Set the permissions so that only the root user has read access:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo chmod <span style=color:#ae81ff>0400</span> /root/.luks_keys/luks_part</span></span></code></pre></div></div><p>Once created the key file, assign it to the LUKS partition:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cryptsetup luksFormat --key-file /root/.luks_keys/luks_part /dev/sdX</span></span></code></pre></div></div><p>Confirm the assignement of the key file with the command <code>cryptsetup luksDump /dev/sdX</code>.</p><p><em>Note: It is possible to add a key file into a pre-existing LUKS-encrypted partition using <code>cryptsetup luksAddKey &lt;device> &lt;path-to-key-file> --key-file &lt;path-to-existing-passphrase-key-file></code> command.</em></p><p>Now we can unlock the partition using the key file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cryptsetup luksOpen /dev/sdX luks_part --key-file /root/.luks_keys/luks_part</span></span></code></pre></div></div><p>If the partition is already opened, then close if using the command <code>cryptsetup -v luksClose luks_part</code>.</p></div></div></div></div><div id=outline-container-headline-6 class=outline-2><h2 id=headline-6>4. Create a Filesystem</h2><div id=outline-text-headline-6 class=outline-text-2><p>Once the LUKS volume is decrypted and opened, we must create a filesystem to store the data on it. Here I use <code class=verbatim>btrfs</code>, but you can use <code class=verbatim>ext4</code> or any other:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>   sudo mkfs.btrfs /dev/mapper/luks_part</span></span></code></pre></div></div><p><em>Note: Make sure you install <code class=verbatim>btrfs-progs</code> to use the <code class=verbatim>btrfs</code> filesystem.</em></p></div></div><div id=outline-container-headline-7 class=outline-2><h2 id=headline-7>5. Mount and unmount a LUKS volume</h2><div id=outline-text-headline-7 class=outline-text-2><p>Now we are ready to mount the LUKS volume. Assume you have a directory called <code class=verbatim>/mnt/data</code> and mount the LUKS volume there:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cryptsetup open /dev/sdX luks_part
</span></span><span style=display:flex><span>  sudo mount /dev/mapper/luks_part /mnt/data</span></span></code></pre></div></div><div id=outline-container-headline-8 class=outline-3><h3 id=headline-8>5.1 Auto-Mount Partition at Startup</h3><div id=outline-text-headline-8 class=outline-text-3><p>If we chose the <a href="*3.1 Encryption and Decryption with Key File">3.1 Encryption and Decryption with Key File</a> method, we can automatically decrypt and open the LUKS volume at system startup by adding an entry to <code class=verbatim>/etc/crypttab</code> file describing the information about the encrypted LUKS volume:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># &lt;target name&gt; &lt;source device&gt; &lt;key-file&gt; &lt;options&gt;
</span></span><span style=display:flex><span>luks_part  UUID=4a3ca3d5-f1e9-4eb4-8fe0-29af8e079f69 /root/.luks_keys/luks_part         luks</span></span></code></pre></div></div><p>Here we use the <code class=verbatim>UUID</code> of the device instead of the device name <code class=verbatim>/dev/sdX</code> as it can change sometimes. The <code class=verbatim>UUID</code> can be obtained using:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cryptsetup luksUUID /dev/sdX</span></span></code></pre></div></div><p>Then, as usual, we can automatically mount the open partition using <code class=verbatim>/etc/fstab</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Mount the encrypted external drive
</span></span><span style=display:flex><span>/dev/mapper/luks_part /mnt/data           btrfs   defaults      0  0</span></span></code></pre></div></div></div></div></div></div></main><footer><hr>© <a href=https://www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 &ndash; 2024 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>