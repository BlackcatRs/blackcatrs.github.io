<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Obtain a TLS Certificate | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Obtain a TLS Certificate</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 1007 words</span></div></div><main><p>We need a TLS certificate to encrypt communication. It will be used in two places:</p><ol><li>Postfix (to encrypt SMTP communication where possible)</li><li>Dovecot (to encrypt IMAP communication and deny any unencrypted traffic)</li></ol><p>But before requesting a certificate from the CA, we need to choose a hostname for the mail server.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Choosing a Hostname for Mail Server</h2><div id=outline-text-headline-1 class=outline-text-2><p>A certificate is issued for a fully qualified domain name like <code class=verbatim>mail.example.com</code> and it will be assigned to the <code class=verbatim>Common Name (CN)</code> attribute in a certificate. This attribute must correspond the hostname during communication, otherwise the certificate will be rejected. But a mail server can be responsible for multiple domain names.</p><p><strong>So what to do ?</strong></p><p><span style=text-decoration:underline>Solution 1:</span> A generic name and a single certificate
The simple solution is to chose a generic name. Some mail provider uses the name <code class=verbatim>mail.domain-name.com</code> for all customers and all domains hosted on their mail server.</p><p>Most users do not care about the host name as long as they get their emails. So I would generally recommend this approach due to its simplicity.</p><p><span style=text-decoration:underline>Solution 2:</span> Multiple names/certificates & SNI
Some people however want to give their mail server as many names as they have domains. Suppose that you have three domains: <code class=verbatim>example1.com</code>, <code class=verbatim>example2.com</code> and <code class=verbatim>example3.com</code>. Users of <code class=verbatim>example1.com</code> can use <code class=verbatim>mail.example1.com</code> while users of <code class=verbatim>example2.com</code> use <code class=verbatim>mail.example2.com</code>.</p><p>As you can imagine this would not work if you had a single certificate because the latter can contain only one CN. If your CN is <code class=verbatim>mail.example1.com</code> then talking to your server by the name <code class=verbatim>mail.example2.com</code> would lead to a certificate error.</p><p>So your mail server needs multiple certificates – one for each host name. And depending on how a user connects to your server you need to send the matching certificate. If the user wants to speak to <code class=verbatim>mail.example1.com</code> then your server needs to send the certificate with CN <code class=verbatim>mail.example1.com</code>.</p><p>Fortunately that problem has been addressed by a technique called <code class=verbatim>Server Name Indication (SNI)</code>. A client talks to the server and even before the encrypted connection is established it tells the server that it expects a certificate for the intended host name. The server can then load the matching certificate and initiate the encryption process.</p><p>SNI has long been a problem for mail servers. The mail user agent (e.g. Thunderbird) needs to support it as well as Postfix and Dovecot. Postfix has finally added SNI in version 3.4 so that we can use it.</p><p>While adding multiple host names needs extra work, it also has a benefit. If you want to move domains to other servers (e.g. when upgrading your server) you can move one domain at a time.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Obtain a Let's Encrypt Certificate</h2><div id=outline-text-headline-2 class=outline-text-2><p>Here we are using Let's Encrypt as a Certificate Authority to sign the certificate we are going to generate. We will use the certbot tool to request an encryption certificate from LetsEncrypt and it will ask us to prove ownership of the domain we are requesting a certificate for.</p><p>The process of obtaining the certificate will be as follows:</p><ol><li>Certbot creates a private key and a certificate request. It sends the certificate request to the LetsEncrypt server.</li><li>The LetsEncrypt server replies with a challenge/token.</li><li>Certbot puts that token into a file in the <code class=verbatim>/var/www/webmail.example.org/.well-known/acme-challenge</code> directory.</li><li>The LetsEncrypt server does an HTTP connection to <a href=http://example.com/.well-known/acme-challenge/...>http://example.com/.well-known/acme-challenge/...</a> and expects to find that token. This verifies that you are in charge of the domain and the web server.</li><li>If all works well the LetsEncrypt server signs your certificate request and thus creates the actual certificate.</li><li>Certbot receives the certificate and puts it into <code class=verbatim>/etc/letsencrypt/archive/webmail.example.org/</code></li></ol><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>Method 1 — Generating a LetsEncrypt Certificate (Apache Web Server)</h3><div id=outline-text-headline-3 class=outline-text-3><p>You need to have an Apache virtual host for <code class=verbatim>mail.example.com</code> before obtaining Let’s Encrypt TLS certificate. Create the virtual host file:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo nano /etc/apache2/sites-available/mail.your-domain.com.conf</span></span></code></pre></div></div><p>Then add the following text into the file:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;VirtualHost *:80&gt;        
</span></span><span style=display:flex><span>        ServerName mail.example.com
</span></span><span style=display:flex><span>        DocumentRoot /var/www/html/
</span></span><span style=display:flex><span>&lt;/VirtualHost&gt;</span></span></code></pre></div></div><p>Save and close the file. Enable this virtual host:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo a2ensite mail.your-domain.com.conf</span></span></code></pre></div></div><p>Then disable the default virtual host, because it might interfere with other virtual hosts:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo a2dissite 000-default</span></span></code></pre></div></div><p>Reload Apache for the changes to take effect:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo systemctl reload apache2</span></span></code></pre></div></div><p>Let’s check if the configuration works. Put a test file into your web root directory:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Just a test&#34;</span> &gt; /var/www/example.com/test</span></span></code></pre></div></div><p>Finally send a HTTP request to <a href=http://mail.example.com/test>http://mail.example.com/test</a> endpoint to test the web server.</p><p>Now we are ready request a certificate for the domain:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  certbot certonly --webroot --webroot-path /var/www/example.com -d example.com</span></span></code></pre></div></div><ul><li><code class=verbatim>-d</code>: Domain name</li></ul></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>Method 2 — Generating a LetsEncrypt Certificate (Standalone)</h3><div id=outline-text-headline-4 class=outline-text-3><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo certbot certonly -d noradrenaline.atomicl.net -m vselvarajah@atomicl.net --standalone --agree-tos --no-eff-email</span></span></code></pre></div></div><ul><li><code class=verbatim>--agree-tos</code>: Agree to terms of service.</li><li><code class=verbatim>--no-eff-email</code>: Don’t receive emails from EFF foundation.</li><li><code class=verbatim>-d</code>: Host for which requesting a certificate.</li></ul></div></div></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Automatic Certificate Renewal</h2><div id=outline-text-headline-5 class=outline-text-2><p>The certbot package automatically adds a timed job that runs twice a day at random times. The random part is important to avoid millions of server hammering the LetsEncrypt service at the same second.</p><p>Cerbot uses Systemd timer instead of a Cron job. You can find the timer definition in the <code class=verbatim>/lib/systemd/system/certbot.timer</code> file. That timer triggers the renewal service defined in <code class=verbatim>/lib/systemd/system/certbot.service</code>. To find out if the service has run and when the next occurence will be, run <code>systemctl status certbot.timer</code>.</p><p>There is also a Cron file at <code class=verbatim>/etc/cron.d/certbot</code> but it do nothing due to the <code class=verbatim>-d /run/systemd/system</code> condition that checks if systemd is installed. And majority of GNU/Linux systems nowadays uses systemd.</p><p>So the renewal already happens automatically. Should it fail then LetsEncrypt start sending you reminder emails that your certificate should be renewed. That’s a clear sign that something went wrong with the automatic renewal.</p><p>There is one puzzle piece missing though. Even if the renewal worked, it will only update the certificate files. But the software components – Postfix and Dovecot – will not notice the change. So we need to add a so called post-hook to certbot that triggers a restart of all processes thereafter.</p><p>For that purpose edit the <code class=verbatim>/etc/letsencrypt/cli.ini</code> file and add:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>post-hook <span style=color:#f92672>=</span> systemctl restart postfix dovecot apache2</span></span></code></pre></div></div><p>You have implemented Let’s Encrypt for all your services now. Let’s move on.</p></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>