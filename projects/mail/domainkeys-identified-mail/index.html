<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>DomainKeys Identified Mail (DKIM) | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>DomainKeys Identified Mail (DKIM)</span></h1><div class=post-meta><span> Published on 27 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 1134 words</span></div></div><main><p>Email sender spoofing involves pretending to control another person's email address. Scammers often send emails with a sender address like <code class=verbatim>someone@paypal.com</code> and hope that the recipient will fall for it and trust them. In fact, SMTP doesn't care what sender address you send from. Many email service providers require you to send emails only with your own email address. But some don't.</p><p>To avoid this problem, a new method was conceived that add a cryptographic signature to the header of an email, which the recipient can check to verify the authenticity of the sender and the integrity of the email.</p><p>The signature is created using a private key that only the sending mail server has. It can then be verified by the recipient by downloading the corresponding public key from the DNS zone of the sending domain and running a signature check. This works very similarly to PGP or S/MIME signing, but at the domain level. Also your mail server automatically sign all outgoing emails.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Configure DKIM</h2><div id=outline-text-headline-1 class=outline-text-2><p>First, install OpenDKIM which is an open-source implementation of the DKIM sender authentication system:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo apt install opendkim opendkim-tools</span></span></code></pre></div></div><p>Then add postfix user to opendkim group.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo gpasswd -a postfix opendkim</span></span></code></pre></div></div><p>Edit OpenDKIM main configuration file.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/opendkim.conf</span></span></code></pre></div></div><p>By default, OpenDKIM logs will be saved in <code class=verbatim>/var/log/mail.log</code> file. Add the following line so OpenDKIM will generate more detailed logs for debugging:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Syslog               yes
</span></span><span style=display:flex><span>Logwhy               yes</span></span></code></pre></div></div><p>Then, find the following lines. Uncomment them and replace <code class=verbatim>simple</code> with <code class=verbatim>relaxed/simple</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#Canonicalization   simple
</span></span><span style=display:flex><span>#Mode               sv
</span></span><span style=display:flex><span>#SubDomains         no</span></span></code></pre></div></div><p>Then add the following lines below <code class=verbatim>#ADSPAction continue</code> line. If your file doesn’t have <code class=verbatim>#ADSPAction continue</code> line, then just add them below <code class=verbatim>SubDomains no</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>AutoRestart         yes
</span></span><span style=display:flex><span>AutoRestartRate     10/1M
</span></span><span style=display:flex><span>Background          yes
</span></span><span style=display:flex><span>DNSTimeout          5
</span></span><span style=display:flex><span>SignatureAlgorithm  rsa-sha256</span></span></code></pre></div></div><p>Next, add the following lines at the end of this file:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#OpenDKIM user
</span></span><span style=display:flex><span># Remember to add user postfix to group opendkim
</span></span><span style=display:flex><span>UserID             opendkim
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Map domains in From addresses to keys used to sign messages
</span></span><span style=display:flex><span>KeyTable           refile:/etc/opendkim/key.table
</span></span><span style=display:flex><span>SigningTable       refile:/etc/opendkim/signing.table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Hosts to ignore when verifying signatures
</span></span><span style=display:flex><span>ExternalIgnoreList  /etc/opendkim/trusted.hosts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># A set of internal hosts whose mail should be signed
</span></span><span style=display:flex><span>InternalHosts       /etc/opendkim/trusted.hosts</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Create Signing Table, Key Table and Trusted Hosts File</h2><div id=outline-text-headline-2 class=outline-text-2><p>Create a directory structure for OpenDKIM:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo mkdir /etc/opendkim
</span></span><span style=display:flex><span>  sudo mkdir /etc/opendkim/keys</span></span></code></pre></div></div><p>Change the owner from root to opendkim and make sure only opendkim user can read and write to the keys directory:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo chown -R opendkim:opendkim /etc/opendkim
</span></span><span style=display:flex><span>  sudo chmod go-rw /etc/opendkim/keys</span></span></code></pre></div></div><p>Create the signing table:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/opendkim/signing.table</span></span></code></pre></div></div><p>Add the following two lines to the file. This tells OpenDKIM that if a sender on your server is using a <code class=verbatim>@example.com</code> address, then it should be signed with the private key identified by <code class=verbatim>default._domainkey.example1.com</code>. The second line tells that your sub-domains will be signed by the private key as well.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>*@example.com    default._domainkey.example.com
</span></span><span style=display:flex><span>*@*.example.com    default._domainkey.example.com</span></span></code></pre></div></div><p>Then create the key table:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/opendkim/key.table</span></span></code></pre></div></div><p>Add the following line, which tells the location of the private key:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>default._domainkey.example1.com     example1.com:default:/etc/opendkim/keys/example1.com/default.private</span></span></code></pre></div></div><p>Next, create the trusted hosts file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/opendkim/trusted.hosts</span></span></code></pre></div></div><p>Add the following lines to the newly created file. This tells OpenDKIM that if an email is coming from localhost or from the same domain, then OpenDKIM should only sign the email but not perform DKIM verification on the email:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>127.0.0.1
</span></span><span style=display:flex><span>localhost
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.example1.com</span></span></code></pre></div></div><p><strong>CAREFUL: You should not add an asterisk in the domain name like this: =</strong>.example1.com=. There should be only a dot before the domain name.*</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Generate Private/Public Keypair</h2><div id=outline-text-headline-3 class=outline-text-2><p>Since DKIM is used to sign outgoing messages and verify incoming messages, we need to generate a private key for signing and a public key for remote verifier. Public key will be published in DNS.</p><p>Create a separate folder for the domain:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo mkdir /etc/opendkim/keys/example1.com</span></span></code></pre></div></div><p>Generate keys using the <code>opendkim-genkey</code> tool, this will store the private key in a <code class=verbatim>default.private</code> file and the public key in the <code class=verbatim>default.txt</code> file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo opendkim-genkey -b <span style=color:#ae81ff>2048</span> -d example1.com -D /etc/opendkim/keys/example1.com -s default -v</span></span></code></pre></div></div><ul><li><code class=verbatim>-b</code>: Create 2048 bits keys.</li><li><code class=verbatim>-d</code>; Specifies the domain.</li><li><code class=verbatim>-D</code>: Specifies the directory where the keys will be stored.</li><li><code class=verbatim>-s</code>: Name of the selector.</li></ul><p>Make opendkim as the owner of the private key:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo chown opendkim:opendkim /etc/opendkim/keys/your-domain.com/default.private</span></span></code></pre></div></div><p>And change the permission, so only the opendkim user has read and write access to the file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo chmod <span style=color:#ae81ff>600</span> /etc/opendkim/keys/your-domain.com/default.private</span></span></code></pre></div></div></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Publish Your Public Key in DNS Record</h2><div id=outline-text-headline-4 class=outline-text-2><p>Display the public key:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo cat /etc/opendkim/keys/example1.com/default.txt</span></span></code></pre></div></div><p>In your DNS, create a TXT record and enter <code class=verbatim>default._domainkey</code> in the name field. Then copy everything between the parentheses and paste it into the value field of the DNS record. You need to delete all double quotes and white spaces in the value field. If you don’t delete them, then the key test in the next step will probably fail.</p></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Test DKIM Key</h2><div id=outline-text-headline-5 class=outline-text-2><p>Enter the following command on Ubuntu server to test your key.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo opendkim-testkey -d example1.com -s default -vvv</span></span></code></pre></div></div><p>If everything is OK, you will see Key OK in the command output:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>opendkim-testkey: using default configfile /etc/opendkim.conf
</span></span><span style=display:flex><span>opendkim-testkey: checking key &#39;default._domainkey.example.com&#39;
</span></span><span style=display:flex><span>opendkim-testkey: key secure
</span></span><span style=display:flex><span>opendkim-testkey: key OK</span></span></code></pre></div></div><p>Your DKIM record may need sometime to propagate to the Internet. Depending on the domain registrar you use, your DNS record might be propagated instantly, or it might take up to 24 hours to propagate. You can also test on some online <sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup> sites to check if the DKIM record is propagated by entering the selector name (in our case <code class=verbatim>default</code>).</p><p>If you see <code class=verbatim>Key not secure</code> in the command output, this is because DNSSEC isn’t enabled on your domain name. DNSSEC is a security standard for secure DNS query. Most domain names haven’t enabled DNSSEC.</p><p>If you see the query timed out error, you need to comment out the following line in <code class=verbatim>/etc/opendkim.conf</code> file and restart <code class=verbatim>opendkim.service</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>TrustAnchorFile       /usr/share/dns/root.key</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-2><h2 id=headline-6>Connect Postfix to OpenDKIM</h2><div id=outline-text-headline-6 class=outline-text-2><p>Postfix can talk to OpenDKIM via a Unix socket file. The default socket file used by OpenDKIM is <code class=verbatim>/var/run/opendkim/opendkim.sock</code>, as shown in <code class=verbatim>/etc/opendkim.conf</code> file. But the postfix SMTP daemon runs in a chroot jail, which means the SMTP daemon resolves all filenames relative to the Postfix directory (<code class=verbatim>/var/spool/postfix</code>). So we need to change the OpenDKIM Unix socket file.</p><p>Create a directory to hold the OpenDKIM socket file and allow only opendkim user and postfix group to access it:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo mkdir /var/spool/postfix/opendkim
</span></span><span style=display:flex><span>  sudo chown opendkim:postfix /var/spool/postfix/opendkim</span></span></code></pre></div></div><p>Then edit the OpenDKIM main configuration file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/opendkim.conf</span></span></code></pre></div></div><p>And replace the <code class=verbatim>Socket local:/run/opendkim/opendkim.sock</code> with (or add) the following line:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Socket    local:/var/spool/postfix/opendkim/opendkim.sock</span></span></code></pre></div></div><p>If you can find any of the following line</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>SOCKET=&#34;local:/var/run/opendkim/opendkim.sock&#34;
</span></span><span style=display:flex><span>SOCKET=local:$RUNDIR/opendkim.sock</span></span></code></pre></div></div><p>Change it to:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>SOCKET=&#34;local:/var/spool/postfix/opendkim/opendkim.sock&#34;</span></span></code></pre></div></div><p>Now we need to edit the Postfix main configuration file:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/postfix/main.cf</span></span></code></pre></div></div><p>Add the following lines at the end of this file, so Postfix can call OpenDKIM via the milter protocol:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Milter configuration
</span></span><span style=display:flex><span>milter_default_action = accept
</span></span><span style=display:flex><span>milter_protocol = 6
</span></span><span style=display:flex><span>smtpd_milters = local:opendkim/opendkim.sock
</span></span><span style=display:flex><span>non_smtpd_milters = $smtpd_milters</span></span></code></pre></div></div><p>Finally restart opendkim and postfix service:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo systemctl restart opendkim postfix</span></span></code></pre></div></div></div></div><div id=outline-container-headline-7 class=outline-2><h2 id=headline-7>Footnotes</h2></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>Test DKIM - <a href=https://www.mimecast.com/products/dmarc-analyzer/dkim-check/>https://www.mimecast.com/products/dmarc-analyzer/dkim-check/</a></p></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>