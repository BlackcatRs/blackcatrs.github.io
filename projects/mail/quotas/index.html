<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Optional — Quotas | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Optional — Quotas</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 1056 words</span></div></div><main><p>Quotas <sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup> are size limits in terms of disk space for users. You can ensure that users do not waste arbitrary amounts of disk space, but are forced to clean up old emails from time to time.</p><p>The magic happens in two places:</p><ol><li>Postfix needs to reject new emails if the user’s mailbox is over quota.</li><li>Dovecot needs to keep track of the quota and how much the user has already used up of it.</li></ol><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Enable Quota Plugin</h2><div id=outline-text-headline-1 class=outline-text-2><p>Uncomment or add the following line to <code class=verbatim>/etc/dovecot/conf.d/10-mail.conf</code> file to enable the quota plugin <sup class=footnote-reference><a id=footnote-reference-2 href=#footnote-2>2</a></sup>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  mail_plugins = quota</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Quota Policy Service</h2><div id=outline-text-headline-2 class=outline-text-2><p>Let’s start with Dovecot. Edit the file <code class=verbatim>/etc/dovecot/conf.d/90-quota.conf</code>. There are several <code class=verbatim>plugin {…}</code> sections. Take one and make it look like:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>plugin {
</span></span><span style=display:flex><span>  quota = count:User quota
</span></span><span style=display:flex><span>  quota_vsizes = yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  quota_status_success = DUNNO
</span></span><span style=display:flex><span>  quota_status_nouser = DUNNO
</span></span><span style=display:flex><span>  quota_status_overquota = &#34;452 4.2.2 Mailbox is full and cannot receive any more emails&#34;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>The first line defines that you want to calculate the used space in a user’s maildir. There are several backends but the <code class=verbatim>count</code> <sup class=footnote-reference><a id=footnote-reference-3 href=#footnote-3>3</a></sup> is the best choice in this context. The string <code class=verbatim>User quota</code> is just an arbitrary string that may be queried from a mail user agent.</p><p>The lines starting with <code class=verbatim>quota_status_…</code> set return values for the service that you will set up in a minute. It will tell Postfix that it will not interfere (DUNNO – colloquial way to say "I don’t know"). And it will return a string with a return code <code class=verbatim>452</code> if the user is over quota. Codes starting with <code class=verbatim>4</code> mean temporary errors. It will tell the sending party that it is worth retrying at a later time. However if the user does not resolve the issue it will lead to a bounce error email after three days.</p><p>In the same file (<code class=verbatim>90-quota.conf</code>) add another section:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>service quota-status {
</span></span><span style=display:flex><span>  executable = /usr/lib/dovecot/quota-status -p postfix
</span></span><span style=display:flex><span>  unix_listener /var/spool/postfix/private/quota-status {
</span></span><span style=display:flex><span>    user = postfix
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>This creates a new Dovecot service responding to requests from other processes. You surely recognize that we put it into the jail that Postfix runs in (<code class=verbatim>/var/spool/postfix</code>), so that Postfix can access it.</p><p>Restart Dovecot:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo systemctl restart dovecot</span></span></code></pre></div></div><p>Take a look at the <code class=verbatim>/var/spool/postfix/private</code> directory. If all went as intended you will find a socket file called <code class=verbatim>quota-status</code> there. Otherwise please check the <code class=verbatim>/var/log/mail.log</code> file for errors.</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Configure Postfix to Reject When Over Quota</h2><div id=outline-text-headline-3 class=outline-text-2><p>If we stopped here, then Dovecot would reject emails for users who have no space left. However Postfix would still happily receive new emails and attempt to forward them to Dovecot via LMTP. Dovecot however will deny that. It will then keep the email in its queue and retry for a while. In the end it will send a bounce back to the sender telling them about the problem.</p><p>Why is this bad ?</p><ol><li>The sender will assume that the email was delivered while it is stuck in the queue for up to three days.</li><li>Spam emails use forged senders. So at the time that Postfix generates the bounce email it will likely send it to an innocent person. This is called backscatter and considered a mail server misconfiguration. Such a problem may get your mail server blacklisted.</li></ol><p>So the next logical step is to make Postfix check whether a mailbox is over quota whenever a new email arrives. Let’s hook up into the <code class=verbatim>RCPT TO</code> phase of the SMTP dialog when a new email comes in. Postfix checks its <code class=verbatim>smtpd_recipient_restrictions</code> configuration at this stage. Run this command in the shell:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf smtpd_recipient_restrictions<span style=color:#f92672>=</span>reject_unauth_destination,<span style=color:#e6db74>&#34;check_policy_service unix:private/quota-status&#34;</span></span></span></code></pre></div></div><p>This adds two checks:</p><ol><li><code class=verbatim>reject_unauth_destination</code> checks whether the mail server is the final destination for the recipient’s email address. This is pretty much the default behavior if you do not define any restrictions.</li><li><code class=verbatim>check_policy_service</code> connects to the socket file at <code class=verbatim>/var/spool/postfix/private/quota-status</code> that was put there by Dovecot. It will use it to ask Dovecot whether the user is over quota in which case the email would get rejected.</li></ol></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Test Quota</h2><div id=outline-text-headline-4 class=outline-text-2><p>Les's set user1’s mailbox quota to 5 KB:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>update</span> virtual_users <span style=color:#66d9ef>set</span> quota<span style=color:#f92672>=</span><span style=color:#ae81ff>4000</span> <span style=color:#66d9ef>where</span> email<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;user1@example1.com&#39;</span>;</span></span></code></pre></div></div><p>Send him a few emails using the <code class=verbatim>swaks</code> tool:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  swaks --server localhost --to user1@example1.com</span></span></code></pre></div></div><p>After a few emails you will see the rejection message:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>-&gt; RCPT TO:user1@example1.com
</span></span><span style=display:flex><span> &lt;** 452 4.2.2 user1@example.org: Recipient address rejected: Mailbox is full and cannot receive any more emails</span></span></code></pre></div></div><p><em>TIPS: If you directly remove files from a user’s Maildir instead of properly accessing the mailbox using IMAP then you will screw up the quota calculation. In that case let Dovecot recalculate the quota — doveadm quota recalc -u user1@example1.com</em></p></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Send Warning Email</h2><div id=outline-text-headline-5 class=outline-text-2><p>The last step is to inform the poor users if they went over quota. So that they do not recognize that on their own. Let’s do that by sending them an email with a warning. We will make sure that the warning email gets through even if the quota is reached.</p><p>Edit the <code class=verbatim>/etc/dovecot/conf.d/90-quota.conf</code> file and add this section to the file:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>plugin {
</span></span><span style=display:flex><span>   quota_warning = storage=95%% quota-warning 95 %u
</span></span><span style=display:flex><span>   quota_warning2 = storage=80%% quota-warning 80 %u
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>service quota-warning {
</span></span><span style=display:flex><span>   executable = script /usr/local/bin/quota-warning.sh
</span></span><span style=display:flex><span>   unix_listener quota-warning {
</span></span><span style=display:flex><span>     user = vmail
</span></span><span style=display:flex><span>     group = vmail
</span></span><span style=display:flex><span>     mode = 0660
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>This section defines two automatic quota warnings. The first (<code class=verbatim>quota_warning</code>) is triggered if the user reaches 95% of the quota. The second (<code class=verbatim>quota_warning2</code>) at 80%. These lines follow this schema:</p><ul><li>Trigger (e.g. <code class=verbatim>storage=95%</code>). The <code class=verbatim>%</code> sign needs to be used twice if you want to emit a literal percent sign. So this is not a typo.</li><li>The socket you want to call in that case. Our socket is the <code class=verbatim>service quota-warning</code> that calls a shell script.</li><li>Additional parameters that are passed to the shell script in our case. They tell the script the percentage that has been reached (e.g. <code class=verbatim>95</code>) and the address of the user who should get the warning.</li></ul><p>No we create a script file at <code class=verbatim>/usr/local/bin/quota-warning.sh</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  <span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>  PERCENT<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>  USER<span style=color:#f92672>=</span>$2
</span></span><span style=display:flex><span>  cat <span style=color:#e6db74>&lt;&lt; EOF | /usr/lib/dovecot/dovecot-lda -d $USER -o &#34;plugin/quota=maildir:User quota:noenforcing&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  From: postmaster@webmail.example.org
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  Subject: Quota warning - $PERCENT% reached
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  Your mailbox can only store a limited amount of emails.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  Currently it is $PERCENT% full. If you reach 100% then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  new emails cannot be stored. Thanks for your understanding.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  EOF</span></span></span></code></pre></div></div><p>Make this file executable:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo chmod +x /usr/local/bin/quota-warning.sh</span></span></code></pre></div></div><p>Restart Dovecot:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo systemctl restart dovecot</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-2><h2 id=headline-6>Footnotes</h2></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>Quota - <a href=https://doc.dovecot.org/2.3/configuration_manual/quota/>https://doc.dovecot.org/2.3/configuration_manual/quota/</a></p></div></div><div class=footnote-definition><sup id=footnote-2><a href=#footnote-reference-2>2</a></sup><div class=footnote-body><p>Quota Plugin - <a href=https://doc.dovecot.org/2.3/configuration_manual/quota_plugin/>https://doc.dovecot.org/2.3/configuration_manual/quota_plugin/</a></p></div></div><div class=footnote-definition><sup id=footnote-3><a href=#footnote-reference-3>3</a></sup><div class=footnote-body><p>Quota Backend: count - <a href=https://doc.dovecot.org/2.3/configuration_manual/quota/quota_count/#quota-backend-count>https://doc.dovecot.org/2.3/configuration_manual/quota/quota_count/#quota-backend-count</a></p></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>