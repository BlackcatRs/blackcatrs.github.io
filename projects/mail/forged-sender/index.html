<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Deny Forged Sender Addresses | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Deny Forged Sender Addresses</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 215 words</span></div></div><main><p>A forged sender address means that someone claims to be someone else. Let’s say that <code class=verbatim>user1</code> has authenticated and the mail server trusts him. Nothing keeps <code class=verbatim>user1</code> from impersonating someone else and sending email in his name.</p><p>Postfix provides a setting called <code class=verbatim>smtpd_sender_login_maps</code> to prevent the problem:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf smtpd_sender_login_maps<span style=color:#f92672>=</span>mysql:/etc/postfix/mysql-email2email.cf</span></span></code></pre></div></div><p>Now create a map file at <code class=verbatim>/etc/postfix/mysql-email2email.cf</code> that Postfix use to search for user's mail address:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>user = mailserver
</span></span><span style=display:flex><span>password = x893dNj4stkHy1MKQq0USWBaX4ZZdq
</span></span><span style=display:flex><span>hosts = 127.0.0.1
</span></span><span style=display:flex><span>dbname = mailserver
</span></span><span style=display:flex><span>query = SELECT email FROM virtual_users WHERE email=&#39;%s&#39;</span></span></code></pre></div></div><p>This sets the parameter both for the SMTP port (25) and the submission port (587). Defining these maps is not enough though. You also need to make Postfix act on this. Edit the <code class=verbatim>/etc/postfix/master.cf</code> again and in the submission section add the following option. Make sure the line is indented like all other options:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> -o smtpd_sender_restrictions=reject_sender_login_mismatch,permit_sasl_authenticated,reject</span></span></code></pre></div></div><p>Restart Postfix:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>systemctl restart postfix</span></span></code></pre></div></div><p>You can now try to send email as a different user than you are logged in. Let’s us swaks again to send a spoofed email:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  swaks --server localhost --from user2@example1.com --to user3example1.com --port <span style=color:#ae81ff>587</span> -tls --auth-user user1@example1.com --auth-password SecurePass</span></span></code></pre></div></div><p>You will get the following error message:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>~&gt; MAIL FROM:user2@example1.com
</span></span><span style=display:flex><span>&lt;~ <span style=color:#ae81ff>250</span> 2.1.0 Ok
</span></span><span style=display:flex><span>~&gt; RCPT TO:user3@example.com
</span></span><span style=display:flex><span>&lt;~* <span style=color:#ae81ff>553</span> 5.7.1 user2@example1.com: Sender address rejected: not owned by user user1@example1.com</span></span></code></pre></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>