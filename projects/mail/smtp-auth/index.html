<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SMTP Authentication | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>SMTP Authentication</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 1164 words</span></div></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Postfix Delegates Authentication to Dovecot</h2><div id=outline-text-headline-1 class=outline-text-2><p>We have already configured Dovecot to know everything about users from the SQL database. So let's tell Postfix to use the Dovecot server as an authentication server to verify the username and password. Run these commands on the shell:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf smtpd_sasl_type<span style=color:#f92672>=</span>dovecot
</span></span><span style=display:flex><span>  sudo postconf smtpd_sasl_path<span style=color:#f92672>=</span>private/auth
</span></span><span style=display:flex><span>  sudo postconf smtpd_sasl_auth_enable<span style=color:#f92672>=</span>yes</span></span></code></pre></div></div><p>Postfix can send authentication request to Dovecot through a socket file located at chroot directory — <code class=verbatim>/var/spool/postfix/private/auth</code>. (Postfix cannot access any file outside <code class=verbatim>/var/spool/postfix</code> directory.</p><p>In a previous section we edited the <code class=verbatim>/etc/dovecot/conf.d/10-master.conf</code> file and made Dovecot place a socket file into <code class=verbatim>/var/spool/postfix/private/auth</code> to allow communication from Postfix.</p><p>The following settings enable encryption, set the key and certificate paths for Postfix:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf smtpd_tls_security_level<span style=color:#f92672>=</span>may
</span></span><span style=display:flex><span>  sudo postconf smtpd_tls_auth_only<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>  sudo postconf smtpd_tls_cert_file<span style=color:#f92672>=</span>/etc/letsencrypt/live/example1.com/fullchain.pem
</span></span><span style=display:flex><span>  sudo postconf smtpd_tls_key_file<span style=color:#f92672>=</span>/etc/letsencrypt/live/example1.com/privkey.pem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sudo postconf smtp_tls_security_level<span style=color:#f92672>=</span>may</span></span></code></pre></div></div><p><em>NOTE: Here we have two types of configuration directives, one starting with <code class=verbatim>smtp_</code> and the second with <code class=verbatim>smtpd_</code>. The <code class=verbatim>smtp_</code> refers to the SMTP client (do not confuse with MUA such as Thunderbird, mutt, etc), the component that sends mail from Postfix to other SMTP servers. <code class=verbatim>smtpd_</code> refers to the SMTP server. This is the component that receives mail from other systems, either from other SMTP server or from one of your SMTP users.</em></p><p>The above settings allow encrypted incoming (<code class=verbatim>smtpd_</code>) and outgoing (<code class=verbatim>smtp_</code>) connections. But they do not enforce it. So if a remote mail server does not have encryption enabled, we will still accept its emails, otherwise the emails will be rejected.</p><p>However the <code class=verbatim>smtpd_tls_auth_only=yes</code> setting makes sure that the user’s authentication information (email address and password) are always encrypted between the user and your mail server.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>How SMTP Authentication Works ?</h2></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Unencrypted SMTP Communication</h2><div id=outline-text-headline-3 class=outline-text-2><p>Let's connect to TCP port 25 on localhost using Telnet:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  telnet localhost <span style=color:#ae81ff>25</span></span></span></code></pre></div></div><p>The server will let you in:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Trying 127.0.0.1…
</span></span><span style=display:flex><span>Connected to localhost.
</span></span><span style=display:flex><span>Escape character is &#39;^]&#39;.
</span></span><span style=display:flex><span>220 webmail ESMTP Postfix (Debian/GNU)</span></span></code></pre></div></div><p>Start the communication by introducing yourself to the SMTP server or in other words specifying the domain name or IP address of the SMTP client:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>ehlo example.com</span></span></code></pre></div></div><p>Postfix will present a list of features that are available for you:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>250-mailtest
</span></span><span style=display:flex><span>250-PIPELINING
</span></span><span style=display:flex><span>250-SIZE 10240000
</span></span><span style=display:flex><span>250-VRFY
</span></span><span style=display:flex><span>250-ETRN
</span></span><span style=display:flex><span>250-STARTTLS
</span></span><span style=display:flex><span>250-ENHANCEDSTATUSCODES
</span></span><span style=display:flex><span>250-8BITMIME
</span></span><span style=display:flex><span>250-DSN
</span></span><span style=display:flex><span>250-SMTPUTF8
</span></span><span style=display:flex><span>250 CHUNKING</span></span></code></pre></div></div><ul><li><code class=verbatim>PIPELINING</code>
This is a feature to speed up SMTP communication. Usually the remote system (who initiate a SMTP connection) has to wait for a response to every command it sends. Pipelining allows the remote server to send several commands in a batch without waiting for a response.
Our Postfix will just store these commands and execute them one by one. If you told Postfix to forbid pipelining it would disconnect the remote server when it tries to send bulks of commands without waiting for the proper reply. It is mainly a feature against rogue senders.</li><li><code class=verbatim>SIZE 10240000</code>
The remote server is allowed to send emails up to 10 MB large. This has long been a common maximum size for emails. However nowadays 40 MB or even more are more common sizes because emails have grown larger. Some mail servers even allow 100 MB.</li><li><code class=verbatim>VRFY</code>
Allows remote servers to verify a given name or email address. For example the remote server could send <code class=verbatim>VRFY user1</code> and your server might respond <code class=verbatim>250 User1 &lt;user1@example1.com></code>. It can be used to verify that a certain recipient email address is deliverable</li><li><code class=verbatim>ETRN</code>
A command that a remote system can send to flush the Postfix queue of mails for a certain domain. It can be used if the remote system had technical problems and failed to receive email for a while. Then it could send an ETRN command to make your server start sending outstanding emails for that domain. It is rarely used.</li><li><code class=verbatim>STARTTLS</code>
This tells the remote system that it might start switching from this unencrypted to an encrypted connection by sending the <code class=verbatim>STARTTLS</code> command. It will then start negotiating a TLS-encrypted connection.
You could compare it to an HTTP connection that suddenly switches over to an encrypted HTTPS connection. The advantage is that you can start talking SMTP on TCP port 25 and don’t have to open up a second TCP port like 465 which is the "SSMTP" (secure SMTP) port and which only accepts encrypted connections.</li><li><code class=verbatim>ENHANCEDSTATUSCODES</code></li></ul><p>This enables more three-digit return codes for various conditions. See the RFC2034 <sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup> for more details.</p><ul><li><code class=verbatim>8BITMIME</code>
In ancient times SMTP only processed 7-bit characters. You couldn’t transfer special characters like <code class=verbatim>Ä</code> or <code class=verbatim>ß</code> without special encoding. The <code class=verbatim>8BITMIME</code> allows a transmission of emails using 8-bit characters. Still many emails are specially encoded using ISO8859-1 or UTF-8.</li><li><code class=verbatim>DSN</code>
It enables DSNs (delivery status notofications) that allows the sender to control the messages that Postfix creates when an email could not be delivered as intended.</li><li><code class=verbatim>SMTPUTF8</code>
In addition to <code class=verbatim>8BITMIME</code> you can use UTF8 encoded characters in header fields.</li><li><code class=verbatim>CHUNKING</code>
This feature (described in RFC 3030) makes sending of large emails more efficient.</li></ul><p>However one important line is missing here that would allow us to send our username and password:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>250-AUTH PLAIN LOGIN</span></span></code></pre></div></div><p>We told Postfix to only allow authentication when the connection is encrypted. So we are not offered authentication over this plain text connection. So we need an encrypted connection using TLS. Using the <code class=verbatim>STARTTLS</code> feature we can switch over from unencrypted to encrypted without having to reconnect. So enter:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>STARTTLS</span></span></code></pre></div></div><p>And the server replies:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>220 2.0.0 Ready to start TLS</span></span></code></pre></div></div><p>However now it’s getting weird because you would have to speak TLS encryption which is not a language that humans speak. So let’s quit this using the <code>QUIT</code> command and do that differently.</p></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Ecrypted SMTP Communication</h2><div id=outline-text-headline-4 class=outline-text-2><p>So we use OpenSSL to help us with the ecryption:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>openssl s_client -connect localhost:25 -starttls smtp</span></span></code></pre></div></div><p>You will see a lot of output. OpenSSL has connected to TCP port 25 and issued a STARTTLS command to switch to an encrypted connection. So whatever you type now will get encrypted. Enter:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>EHLO example.com</span></span></code></pre></div></div><p>And Postfix will send a list of capabilities that will look like this:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>250-PIPELINING
</span></span><span style=display:flex><span>250-SIZE 10240000
</span></span><span style=display:flex><span>250-VRFY
</span></span><span style=display:flex><span>250-ETRN
</span></span><span style=display:flex><span>250-AUTH PLAIN LOGIN
</span></span><span style=display:flex><span>250-ENHANCEDSTATUSCODES
</span></span><span style=display:flex><span>250-8BITMIME
</span></span><span style=display:flex><span>250 DSN</span></span></code></pre></div></div><p>And now that we are using an encrypted connection Postfix offers us to authenticate. So let us send the authentication string with a Base64-encoded password:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>AUTH PLAIN AGpvaG5AZXhhbXBsZS5vcmcAc3VtbWVyc3Vu</span></span></code></pre></div></div><ul><li><p>We use an encoded string because, in general, SMTP can only transfer ASCII characters. But the email address may contain special characters that are not covered by ASCII. So, in the PLAIN method, we encode the foloowing information in Base64 — <code class=verbatim>NULL-BYTE + USERNAME + NULL-BYTE + PASSWORD</code>.</p><p>So for user1’s case you can easily create the Base64 string using:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  printf <span style=color:#e6db74>&#39;\0user1@example1.com\0SecurePass&#39;</span> | base64</span></span></code></pre></div></div></li></ul><p>Unless you have changed user1's password to something else than <code class=verbatim>SecurePass</code> the server should accept that authentication:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>235 2.7.0 Authentication successful</span></span></code></pre></div></div><p>Excellent. You are logged in through SMTP. You could now send an email to be forwarded to another mail server. Here I just wanted to show that authentication works if you use an encrypted connection.</p><p>Disconnect from Postfix:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>QUIT</span></span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Footnotes</h2></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>SMTP Service Extension for Returning Enhanced Error Codes - <a href=https://datatracker.ietf.org/doc/html/rfc2034>https://datatracker.ietf.org/doc/html/rfc2034</a></p></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>