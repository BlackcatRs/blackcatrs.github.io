<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Postfix and Dovecot Communication | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Postfix and Dovecot Communication</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 641 words</span></div></div><main><p>In a previous chapters we made sure that Postfix knows which emails it is allowed to receive. Now what to do with the email?</p><p>It has to be saved to disk into the mailbox of the mail user who is waiting for it. You could let Postfix handle that using its built-in mail delivery agent (MDA) called <code class=verbatim>virtual</code>. However compared to the capabilities that Dovecot provides like server-based sieve rules or quotas, the Postfix delivery agent is pretty basic. We are using Dovecot anyway to provide the IMAP (and optionally POP3) service. So let’s use its delivery agent.</p><p>How can we make Postfix hand over the email to Dovecot? There are generally two ways to establish that link.</p><ol><li>Using the <code class=verbatim>dovecot-lda</code> (local delivery agent) process. It can process one email at a time. And it starts up a new process for every email. This was for long the default way. But as you can imagine that it does not scale well.</li><li>The better option is to use <code class=verbatim>LMTP (Local Mail Transport Protocol)</code> that was conceived for this purpose. It can handle multiple recipients at the same time and has a permanently running process which provides a better performance than using the LDA. In short, LMTP is a variant of SMTP with fewer features. It is meant for email communication between internal services that trust each other.</li></ol><p>We are going for the second option. You installed the <code class=verbatim>dovecot-lmtpd</code> package earlier. So let’s configure it.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Configure Dovecot to Listen for LMTP Connections from Postfix</h2><div id=outline-text-headline-1 class=outline-text-2><p>Edit Dovecot’s configuration file <code class=verbatim>/etc/dovecot/conf.d/10-master.conf</code> that deals with the LMTP daemon. Look for the <code class=verbatim>service lmtp</code> section and edit it so that it looks like:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>service lmtp {
</span></span><span style=display:flex><span>  unix_listener /var/spool/postfix/private/dovecot-lmtp {
</span></span><span style=display:flex><span>    group = postfix
</span></span><span style=display:flex><span>    mode = 0600
</span></span><span style=display:flex><span>    user = postfix
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>This makes Dovecot’s lmtp daemon create a UNIX socket at <code class=verbatim>/var/spool/postfix/private/dovecot-lmtp</code>. Just like in the section dealing with setting up Dovecot we make it put a socket into the <code class=verbatim>/var/spool/postfix</code> chroot directory because Postfix is restricted to that directory and cannot access anything outside of it. So from Postfix’s point of view the socket is located at <code class=verbatim>/private/dovecot-lmtp</code>.</p><p>Restart Dovecot:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo systemctl restart dovecot</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Configure Postfix to Deliver Mails to Dovecot using LMTP</h2><div id=outline-text-headline-2 class=outline-text-2><p>The <code class=verbatim>virtual_transport</code> in Postfix defines the service to use for delivering emails to the local system. Dovecot has created a socket file and is ready to listen to incoming LMTP connections. We just need to tell Postfix to send emails there:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf virtual_transport<span style=color:#f92672>=</span>lmtp:unix:private/dovecot-lmtp</span></span></code></pre></div></div><p>We just told Postfix to use the LMTP protocol. And we want to use a UNIX socket on the same system (instead of a TCP connection). And the socket file is located at <code class=verbatim>/var/spool/postfix/private/dovecot-lmtp</code>.</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Enable server-side mail rules&#160;&#160;&#160;<span class=tags><span>ARCHIVE</span></span></h2><div id=outline-text-headline-3 class=outline-text-2><p>One of my favorite features of Dovecot are automatic rules for incoming email that are processed on the server. You can sort away your mailing list emails into special folders. You can reject certain senders. Or you can set up vacation auto-responders. No need to have a mail client running – it all happens automatically on the server even when your mail users are not connected.</p><p>The open-source standard (RFC 5228) for such rules is called Sieve. Basically, Sieve is a way to manage server-side email rules. A rule consists of conditions and actions. For example if the sender address matches <code class=verbatim>user2@example1.com</code> you could tell Dovecot to move such emails to your <code class=verbatim>user2</code> folder automatically. These rules are stored on the Dovecot server and executed automatically. Whether you connect from your smartphone your laptop or use the webmail access – the rules always work and require no configuration on the client side.</p><p>As we use LMTP that’s where we need to tell the lmtp service that we want to use Dovecot’s <code class=verbatim>sieve</code> plugin. Edit the file <code class=verbatim>/etc/dovecot/conf.d/20-lmtp.conf</code> and within the <code class=verbatim>protocol lmtp</code> section change the <code class=verbatim>mail_plugins</code> line to:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mail_plugins = $mail_plugins sieve</span></span></code></pre></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>