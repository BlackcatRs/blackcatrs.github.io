<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Configure Database — MySQL | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Configure Database — MySQL</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 611 words</span></div></div><main><p>In this section we will create a database <code class=verbatim>mailserver</code> and two users. The first user <code class=verbatim>mailadmin</code> will be able to modify the database data and is intended for mail server administrator. The other user <code class=verbatim>mailserver</code> can only read the database data and is intended for server processes.</p><p>First we need to create two random passwords for these users using the pwgen tool:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  pwgen -s1 <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>2</span></span></span></code></pre></div></div><p>Take a note of the passwords or store them somewhere safe.</p><p>Connect to the database:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo mysql</span></span></code></pre></div></div><p>Create a database:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> mailserver;</span></span></code></pre></div></div><p>Now we have an empty database. Let's create the user <code class=verbatim>mailadmin</code> and give the necessary privileges to manage the database:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grant all on mailserver.* to <span style=color:#e6db74>&#39;mailadmin&#39;</span>@<span style=color:#e6db74>&#39;localhost&#39;</span> identified by <span style=color:#e6db74>&#39;gefk6lA2brMOeb8eR5WYaMEdKDQfnF&#39;</span>;</span></span></code></pre></div></div><p><strong>CAREFUL: Please use the first password you just generated instead of mine.</strong></p><p>Also create the read-only user that will be used by Postfix and Dovecot to access the database:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grant <span style=color:#66d9ef>select</span> on mailserver.* to <span style=color:#e6db74>&#39;mailserver&#39;</span>@<span style=color:#e6db74>&#39;127.0.0.1&#39;</span> identified by <span style=color:#e6db74>&#39;x893dNj4stkHy1MKQq0USWBaX4ZZdq&#39;</span>;</span></span></code></pre></div></div><p><strong>CAREFUL: Use your second random password here instead of mine.</strong></p><p><em>NOTE:
/Here we are using <code class=verbatim>127.0.0.1</code> instead of <code class=verbatim>localhost</code> because MariaDB (and Oracle’s MySQL) distinguishes between the two. If you initiate a database connection to <code class=verbatim>localhost</code> then you talk to the socket file which lives at <code class=verbatim>/var/run/mysqld/mysqld.sock</code> on your server. But if you connect to <code class=verbatim>127.0.0.1</code> it will create a network connection talking to the TCP socket on port 3306 on your server.</em>
<em>The difference is that any process on your server can talk to 127.0.0.1. But the socket file has certain <code class=verbatim>user/group/other</code> permissions just like any other file on your file system.</em>
<em>Postfix will be restricted to its <code class=verbatim>/var/spool/postfix</code> directory and cannot by default access that socket file. So by using 127.0.0.1 we circumvent that limitation.</em></p><p>Let's create tables to store virtual domains, virtual aliases and virtual users. This table just holds the list of domains that you will use as <code class=verbatim>virtual_mailbox_domains</code> in Postfix:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>USE mailserver;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>virtual_domains<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> auto_increment,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>50</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span> ) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;</span></span></code></pre></div></div><p>The next table contains information about your users:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>virtual_users<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> auto_increment,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>domain_id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>email<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>password<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>150</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>quota<span style=color:#f92672>`</span> bigint(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>),
</span></span><span style=display:flex><span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>KEY</span> <span style=color:#f92672>`</span>email<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>email<span style=color:#f92672>`</span>),
</span></span><span style=display:flex><span> <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (domain_id) <span style=color:#66d9ef>REFERENCES</span> virtual_domains(id) <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>
</span></span><span style=display:flex><span> ) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;</span></span></code></pre></div></div><p>The last table contains forwardings from an email address to other email addresses:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>virtual_aliases<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> auto_increment,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>domain_id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span><span style=color:#66d9ef>source</span><span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>`</span>destination<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>),
</span></span><span style=display:flex><span> <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (domain_id) <span style=color:#66d9ef>REFERENCES</span> virtual_domains(id) <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>
</span></span><span style=display:flex><span> ) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;</span></span></code></pre></div></div><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Example Data</h2><div id=outline-text-headline-1 class=outline-text-2><p>Let’s populate the database with an <code class=verbatim>example1.com</code> domain, a <code class=verbatim>user1@example1.com</code> email account and a forwarding of <code class=verbatim>postmaster@example1.com</code> to <code class=verbatim>user1@example1.com</code>.</p><p>To add that sample data just run these SQL queries:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>INTO</span> mailserver.virtual_domains (id,name) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;1&#39;</span>,<span style=color:#e6db74>&#39;example1.com&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>INTO</span> mailserver.virtual_users (id,domain_id,password,email)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;{BLF-CRYPT}$2y$05$4OM6TTQ45gXcMcgtfiwdd.FwaeY8lOu3xaYxChjmg/vpyOPTnEpTK&#39;</span>, <span style=color:#e6db74>&#39;user1@example1.com&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>INTO</span> mailserver.virtual_aliases (id,domain_id,<span style=color:#66d9ef>source</span>,destination)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;postmaster@example1.com&#39;</span>, <span style=color:#e6db74>&#39;user1@example1.com&#39;</span>);</span></span></code></pre></div></div><p>The string used in the password column is a secure hash of the simple password <code class=verbatim>SecurePass</code> and is generated using the following command:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  doveadm pw -s BLF-CRYPT</span></span></code></pre></div></div><p>Once you have installed Dovecot you can try that yourself but you will get a different output. The reason is that the passwords are salted to increase their security.</p><p>Don't forget to delete this sample data before putting your mail server into production. With the delete cascade, you only need to delete the virtual domain. The alias and mailbox will be automatically deleted. Here is the SQL query you need to run before putting your mail server into production:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> mailserver.virtual_domains <span style=color:#66d9ef>WHERE</span> name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;example1.com&#39;</span>;</span></span></code></pre></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>