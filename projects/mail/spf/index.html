<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Sender Policy Framework (SPF) | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Sender Policy Framework (SPF)</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 487 words</span></div></div><main><p>A Sender Policy Framework (SPF) is a method to verify that the mail server sending the email is authorized to send mail on behalf of the domain.</p><p>The receiving SMTP mail server queries the DNS server of the domain found in the header of the received email — <code class=verbatim>Return-Path</code>, for a TXT record. This record contains the IP addresses of the authorized mail servers defined by the domain owner to send mail on behalf of the domain in question.</p><p>This record also indicates the receiving SMTP server to allow, reject or mark as spam if the SPF check fails, in other words if the IP address of the sending SMTP server does not match the IP address retrieved from the TXT record.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Create an SPF Record in DNS</h2><div id=outline-text-headline-1 class=outline-text-2><p>Let's create a new TXT record in DNS to tell the receiving SMTP server which IP addresses are allowed to send mail for your domain:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  TXT  @   v=spf1 mx ~all</span></span></code></pre></div></div><ul><li><code class=verbatim>TXT</code>: Indicates this is a TXT record.</li><li><code class=verbatim>@</code>: Represents the domain.</li><li><code class=verbatim>v=spf1</code> Indicates an SPF record and the SPF record version is SPF1.</li><li><code class=verbatim>mx</code>: Allow all hosts listed in the MX records to send emails for your domain and all other hosts are disallowed.</li><li><code class=verbatim>~all</code>: Indicates that emails from your domain should only come from hosts specified in the SPF record. Emails that are from other hosts will be flagged as untrustworthy. Possible alternatives are <code class=verbatim>+all</code>, <code class=verbatim>-all</code>, <code class=verbatim>?all</code>.(E.g: <code class=verbatim>-all</code> means emails sent from not-allowed hosts should be rejected, never to land in the recipient’s inbox or spam folder)</li></ul><p>To check if your SPF record is propagated on the Internet, query a DNS server for your domain's TXT record:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  dig your-domain.com txt</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>SPF Check for Incoming Emails</h2><div id=outline-text-headline-2 class=outline-text-2><p>We have created a TXT record in DNS to inform the other SMTP server that receiving emails our authorized SMTP servers. Now we need to tell our Postfix server to do this check before accepting mail.</p><p>Install required SPF package:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo apt install postfix-policyd-spf-python</span></span></code></pre></div></div><p>Then edit the Postfix master process configuration file:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo nano /etc/postfix/master.cf</span></span></code></pre></div></div><p>Add the following lines at the end of the file, which tells Postfix to start the SPF policy daemon when it’s starting itself:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>policyd-spf  unix  -       n       n       -       0       spawn
</span></span><span style=display:flex><span>    user=policyd-spf argv=/usr/bin/policyd-spf</span></span></code></pre></div></div><p>Save and close the file. Next, edit Postfix main configuration file.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo nano /etc/postfix/main.cf</span></span></code></pre></div></div><p>Append the following lines at the end of the file. The first line specifies the Postfix policy agent timeout setting. The following lines will impose a restriction on incoming emails by checking SPF record.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>policyd-spf_time_limit = 3600
</span></span><span style=display:flex><span>smtpd_recipient_restrictions =
</span></span><span style=display:flex><span>   reject_unauth_destination,
</span></span><span style=display:flex><span>   check_policy_service unix:private/quota-status,
</span></span><span style=display:flex><span>   check_policy_service unix:private/policyd-spf</span></span></code></pre></div></div><p>Save and close the file. Then restart Postfix.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo systemctl restart postfix</span></span></code></pre></div></div><p>Next time, when you receive an email from a domain that has an SPF record, you can see the SPF check results in the raw email header. The following header indicates the sender sent the email from an authorized host.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Received-SPF: Pass (sender SPF authorized).</span></span></code></pre></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>