<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Configure Postfix | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Configure Postfix</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 506 words</span></div></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Configure Domain</h2><div id=outline-text-headline-1 class=outline-text-2><p>Postfix receives an email for <code class=verbatim>user1@example1.com</code> and wants to find out if <code class=verbatim>example1.com</code> is a virtual mailbox domain. It will run the below SQL query and replace <code class=verbatim>%s</code> by <code class=verbatim>example1.com</code>. If it finds such a row in the <code class=verbatim>virtual_domains</code> table it will return a <code class=verbatim>1</code>. Actually it does not matter what exactly is returns as long as there is a result.</p><p>Edit the file <code class=verbatim>/etc/postfix/mysql-virtual-mailbox-domains.cf</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>user = mailserver
</span></span><span style=display:flex><span>password = x893dNj4stkHy1MKQq0USWBaX4ZZdq
</span></span><span style=display:flex><span>hosts = 127.0.0.1
</span></span><span style=display:flex><span>dbname = mailserver
</span></span><span style=display:flex><span>query = SELECT 1 FROM virtual_domains WHERE name=&#39;%s&#39;</span></span></code></pre></div></div><p>Now you need to make Postfix use this database mapping. The <code class=verbatim>postconf</code> command adds configuration lines to <code class=verbatim>/etc/postfix/main.cf</code> file. It also activates the new setting instantly so you do not have to reload the Postfix process:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf virtual_mailbox_domains<span style=color:#f92672>=</span>mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf</span></span></code></pre></div></div><p>The test data you created earlier added the domain <code class=verbatim>example1.com</code> as one of your mailbox domains. Let’s ask Postfix if it recognizes that domain:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postmap -q example1.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Configure User</h2><div id=outline-text-headline-2 class=outline-text-2><p>You will now define the <code class=verbatim>virtual_mailbox_maps</code>. It will map a recipient’s email address to the location of the user’s mailbox on your hard disk. Postfix has a built-in transport service called <code class=verbatim>virtual</code> that can receive the email and store it into the recipient’s email directory. That service is pretty limited, so we will delegate that to Dovecot as it allows us better control.</p><p>Postfix will forward all emails to Dovecot for further delivery. But we need to make sure that the recipient actually exists before we do that. So Postfix needs to check whether an email address belongs to a valid mailbox.</p><p>We need an SQL query that searches for an email address and returns <code class=verbatim>1</code> if it is found. To accomplish that please create another configuration file at <code class=verbatim>/etc/postfix/mysql-virtual-mailbox-maps.cf</code>:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>user <span style=color:#f92672>=</span> mailserver
</span></span><span style=display:flex><span>password <span style=color:#f92672>=</span> x893dNj4stkHy1MKQq0USWBaX4ZZdq
</span></span><span style=display:flex><span>hosts <span style=color:#f92672>=</span> 127.0.0.1
</span></span><span style=display:flex><span>dbname <span style=color:#f92672>=</span> mailserver
</span></span><span style=display:flex><span>query <span style=color:#f92672>=</span> SELECT <span style=color:#ae81ff>1</span> FROM virtual_users WHERE email<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;%s&#39;</span></span></span></code></pre></div></div><p>Tell Postfix that this mapping file is supposed to be used for the <code class=verbatim>virtual_mailbox_maps</code> mapping:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf virtual_mailbox_maps<span style=color:#f92672>=</span>mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf</span></span></code></pre></div></div><p>Test if Postfix is happy with this mapping by asking it where the mailbox directory of our <code class=verbatim>user1@example.com</code> user would be:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postmap -q user1@example1.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf</span></span></code></pre></div></div><p>Again you should get <code class=verbatim>1</code> back which means that <code class=verbatim>user1@example1.com</code> is an existing virtual mailbox user on your server.</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Configure Alias</h2><div id=outline-text-headline-3 class=outline-text-2><p>Here your are going to define <code class=verbatim>virtual_alias_maps</code> mapping which is used for forwarding emails from one email address to one or more others. In the database multiple targets are achieved by using multiple rows.</p><p>Create another file at <code class=verbatim>/etc/postfix/mysql-virtual-alias-maps.cf</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>user = mailserver
</span></span><span style=display:flex><span>password = x893dNj4stkHy1MKQq0USWBaX4ZZdq
</span></span><span style=display:flex><span>hosts = 127.0.0.1
</span></span><span style=display:flex><span>dbname = mailserver
</span></span><span style=display:flex><span>query = SELECT destination FROM virtual_aliases WHERE source=&#39;%s&#39;</span></span></code></pre></div></div><p>Make Postfix use this database mapping:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postconf virtual_alias_maps<span style=color:#f92672>=</span>mysql:/etc/postfix/mysql-virtual-alias-maps.cf</span></span></code></pre></div></div><p>Test if the mapping file works as expected:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo postmap -q postmaster@example1.com mysql:/etc/postfix/mysql-virtual-alias-maps.cf</span></span></code></pre></div></div><p>You should see the expected destination:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  user1@example1.com</span></span></code></pre></div></div><p>So if Postfix receives an email for <code class=verbatim>postmaster@example1.com</code> it will redirect it to <code class=verbatim>user1@example1.com</code>.</p></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Fix Permissions</h2><div id=outline-text-headline-4 class=outline-text-2><p>We need to make sure that only <code class=verbatim>root</code> and the <code class=verbatim>postfix</code> user can read the <code class=verbatim>.cf</code> files because database password is stored these files:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  chgrp postfix /etc/postfix/mysql-*.cf
</span></span><span style=display:flex><span>  chmod u<span style=color:#f92672>=</span>rw,g<span style=color:#f92672>=</span>r,o<span style=color:#f92672>=</span> /etc/postfix/mysql-*.cf</span></span></code></pre></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>