<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Install Your Own Mail Server | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/header-num.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><h1>Install Your Own Mail Server</h1><p>Email is a critical part of communication, both for individuals and businesses. While most people rely on third-party email providers like Gmail, Outlook, or Yahoo, setting up your own mail server on a GNU/Linux system offers several key advantages—greater control, privacy, and customization.</p><p>One of the biggest concerns with using commercial email providers is confidentiality. Your emails pass through third-party servers, where they may be scanned, stored, or even shared for advertising and data analysis purposes. When you run your own mail server, you maintain full control over your messages, ensuring that sensitive communications remain private and secure. This is especially crucial for businesses handling confidential client data, or privacy-conscious individuals who do not want their emails monitored.</p><p>Beyond privacy, owning a mail server allows for advanced customization, better security configurations, and avoiding potential service outages or censorship from big providers. While setting up and maintaining a mail server requires effort and technical knowledge, the benefits of full control over your email far outweigh the challenges.</p><p>In this guide, I’ll walk you through the step-by-step process of setting up your own mail server on a GNU/Linux system, helping you take charge of your communication security.</p><p>Managing mails involves several software component (IMAP, SMTP, Anti-spam), that is why we call it as mail infrastructure instead of a simple mail server.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>How Do Your Users Fetch Emails ?</h2><div id=outline-text-headline-1 class=outline-text-2><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Mail User Agent</h3><div id=outline-text-headline-2 class=outline-text-3><p>The user usually has a mail client or MUA — Mail User Agent (Thunderbird, Mutt, etc…), that can use the POP3 or IMAP protocol to fetch emails from the server.</p><p>That mail client connects to the POP3 (TCP 110) or IMAP (TCP 143) port on the server and may or may not send the <code>STARTTLS</code> command that initiates an encrypted connection. It then sends the user's username (which is equal to the email address in our case) and their password. POP3 is less used nowadays and lacks of support for multiple folders on the server.</p><p>The client may as well use the secure TLS-encrypted ports directly — 995 for POPs or 993 for IMAPs.</p></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>IMAP Server</h3><div id=outline-text-headline-3 class=outline-text-3><p>Dovecot sends a query to the MySQL database and verifies that the username and password belong to a known user. If the password is wrong then Dovecot will refuse the login.</p><p>As defined in the Devecot configuration file, each user has a directory where emails are stored. So if the user is named <code class=verbatim>vselvarajah@atomicl.net</code>, Dovecot will look for the mail directory in <code class=verbatim>/var/vmail/atomicl.net/vselvarajah/Maildir/…</code> and save the email in the corresponding mail directory.</p><p><strong>NOTE: We can also integrate a webmail service so users can send/read mails using the browser but we are not going to do that here.</strong></p></div></div></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>How Do Users Send Emails ?</h2><div id=outline-text-headline-4 class=outline-text-2><p><img src=./img/smtp.jpg alt=./img/smtp.jpg title=./img/smtp.jpg></p><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>Mail User Agent</h3><div id=outline-text-headline-5 class=outline-text-3><p>The user writes the email using a mail user agent (MUA) such as Thunderbird, Mutt, etc. And clicks on "Send". The mail client establishes an SMTP connection to your Postfix server on port 25 or 587. In most cases, the user's internet service provider blocks port 25 to prevent spam, so users use port 587.</p><p>To ensure that the user is allowed to send emails to other SMTP servers through your system, a username (or email address) and password are required.</p><p>In the guide we instruct Postfix to use encryption for authentication for security reasons, but this is completely optional.</p></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>SMTP Verification</h3><div id=outline-text-headline-6 class=outline-text-3><p>Your Postfix server checks the email address and password in the database. Or it can delegate to another service like Dovecot to handle authentication.</p><p>Then Dovecot sends a query to the MariaDB database to check if the email address and password are correct and tells Postfix the result.</p></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>SMTP Response</h3><div id=outline-text-headline-7 class=outline-text-3><p>Postftix knows now that it is authorized to send the email on behalf of the user. It tells the user that it successfully accepted the email. The email is put into Postfix’s mail queue for further processing. Postfix will now query a DNS server to determine mail server of recipient. As the recipient has an <code class=verbatim>...@recipient-domain.com</code> email address it checks the MX record of the <code class=verbatim>recipient-domain.com</code> domain and then gets the respective IP address.</p></div></div><div id=outline-container-headline-8 class=outline-3><h3 id=headline-8>SMTP Establish Connection</h3><div id=outline-text-headline-8 class=outline-text-3><p>Postfix now knows which mail server to send the email to. It opens an SMTP connection and delivers the email.</p></div></div></div></div><div id=outline-container-headline-9 class=outline-2><h2 id=headline-9>How Emails Are Transferred ?</h2><div id=outline-text-headline-9 class=outline-text-2><p><img src=./img/Mail_Infra.jpg alt=./img/Mail_Infra.jpg title=./img/Mail_Infra.jpg></p><p>Les's see how mails get transferred to <code class=verbatim>vselvarajah@atomicl.net</code> recipient from some else.</p><div id=outline-container-headline-10 class=outline-3><h3 id=headline-10>Query DNS</h3><div id=outline-text-headline-10 class=outline-text-3><ol><li>SENDER's SMTP: Query DNS server for email server of the domain <code class=verbatim>atomicl.net</code>.</li><li>DNS: Checks MX record of <code class=verbatim>atomicl.net</code> domain for mails servers and sends the IP address.</li></ol></div></div><div id=outline-container-headline-11 class=outline-3><h3 id=headline-11>Establish Connection</h3><div id=outline-text-headline-11 class=outline-text-3><ol><li>SENDER's SMTP: Connects to that IP on TCP port 25 which is by default used by SMTP server (Simple Mail Transport Protocol)</li><li>MY POSTFIX: Welcome, I am Postfix server. Who is there ? (<code>220 mail.atomicl.net ESMTP Postfix</code>)</li><li>SENDER's SMTP: Hi, I am a remote server. (<code>EHLO mail.sender-domain.com</code>)</li><li>MY POSTFIX: Nice to meet you. I can offer you a few features like pipelining and encryption… (<code>STARTTLS, PIPELINING, SIZE 4000000, …</code>)</li><li>SENDER's SMTP: OK, then we switch to an encrypted connection. (<code>STARTTLS</code>)
<em>The connection is now using TLS encryption.</em></li><li>SENDER's SMTP: I have an email from <code class=verbatim>user@sender-domain.com</code> (<code>MAIL FROM:&lt;user@sender-domain.com></code>)</li><li>MY POSTFIX: I see. (<code>Ok</code>)</li><li>SENDER's SMTP: This email is for <code class=verbatim>vselvarajah@atomicl.net</code> (<code>RCPT TO:&lt;vselvarajah@atomicl.com></code>)</li></ol></div></div><div id=outline-container-headline-12 class=outline-3><h3 id=headline-12>Query DB</h3><div id=outline-text-headline-12 class=outline-text-3><ol><li>MY POSTFIX: Hi database. (Connects to TCP port 3306 on the local host to talk to MariaDB.) Could you check if <code class=verbatim>atomicl.net</code> is one of our mail domains ? (<code>SELECT … from virtual_domains …</code>)</li><li>MY MariaDB: Yes, I have a that domain in my database.</li><li>MY POSTFIX: Nice. And do you have a mailbox or a forwarding rule for <code class=verbatim>vselvarajah@atomicl.net</code> ? (<code>SELECT … from virtual_aliases/virtual_users …</code>)</li><li>MY MARIADB: Yes, there is a mailbox for that address.</li><li>MY POSTIFX: Remote server, the recipient looks good. (<code>Ok</code>)</li><li>SENDER'S SMTP: Good. Then here’s the actual email. (<code>DATA</code>)
<em>The remote server sends the email header and body.</em></li></ol></div></div><div id=outline-container-headline-13 class=outline-3><h3 id=headline-13>Check for Spam</h3><div id=outline-text-headline-13 class=outline-text-3><ol><li>MY POSTFIX: Connects to port 11332 on the local host to reach the <code class=verbatim>rspamd</code>.</li><li><span style=text-decoration:underline>My Postfix:</span> Hi, rspamd. I have a new email. Could you spam check ?</li><li><span style=text-decoration:underline>MY RSPAMD:</span> Sure. Well, there are a few minor issues. But generally the mail looks good. I suggest you accept it.</li></ol></div></div><div id=outline-container-headline-14 class=outline-3><h3 id=headline-14>SMTP Response</h3><div id=outline-text-headline-14 class=outline-text-3><ol><li><span style=text-decoration:underline>MY POSTFIX:</span> Hey, remote server. Your email is fine.</li></ol></div></div><div id=outline-container-headline-15 class=outline-3><h3 id=headline-15>Mail Delivery</h3><div id=outline-text-headline-15 class=outline-text-3><ol><li><span style=text-decoration:underline>MY POSTFIX</span>: Uses a socket file at <code class=verbatim>/var/spool/postfix/private/dovecot-lmtp</code> to talk to Dovecot.</li><li><span style=text-decoration:underline>MY POSTFIX</span>: Hi, Dovecot. Here is a new email for <code class=verbatim>vselvarajah@atomicl.net</code></li><li><span style=text-decoration:underline>MY DOVECOT</span>: Got it.</li></ol></div></div><div id=outline-container-headline-16 class=outline-3><h3 id=headline-16>Check Sieve Rules (Optional)</h3><div id=outline-text-headline-16 class=outline-text-3><ol><li>MY DOVECOT: Checks for additional Sieve rules and then stores the email on disk at <code class=verbatim>/var/vmail/atomicl.net/vselvarajah/Maildir/INBOX</code></li></ol></div></div></div></div><div id=outline-container-headline-17 class=outline-2><h2 id=headline-17>Prerequisites</h2><div id=outline-text-headline-17 class=outline-text-2><ol><li><code class=verbatim>GNU/Linux</code> operating system (This guides is uses Debian 12)</li><li><code class=verbatim>Postfix</code> receives incoming emails from the internet and sends out outgoing emails to other mail servers. It is the software that speaks SMTP.</li><li><code class=verbatim>rspamd</code> runs sanity checks on an incoming email to determine whether it is spam.</li><li><code class=verbatim>Dovecot</code> stores emails on your hard disk, applies filters and lets your users fetch their emails using the POP3 and IMAP protocols</li><li><code class=verbatim>MariaDB</code> is a database that stores information about your domains, email aliases and email accounts</li></ol><p>Let's install all required packages:</p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  sudo apt install mariadb-server postfix postfix-mysql dovecot-mysql dovecot-imapd dovecot-lmtpd mutt certbot ca-certificates telnet swaks</span></span></code></pre></div></div></div></div><div id=outline-container-headline-18 class=outline-2><h2 id=headline-18>Installation</h2><div id=outline-text-headline-18 class=outline-text-2><p>Welcome to the guide on setting up your own mail server. Below are the steps to follow:</p><ol><li><a href=./postfix>SMTP server — Postfix</a></li><li><a href=./dovecot>IMAP server — Dovecot</a></li><li><a href=./obtain-certificate>Obtain TLS certificate</a></li><li><a href=./configure-db>Configure DB</a></li><li><a href=./configure-postfix>Configure Postfix</a></li><li><a href=./configure-dovecot>Configure Dovecot</a></li><li><a href=./postfix-dovecot-com>Postfix and Dovecot communication</a></li><li><a href=./quotas>Optional — Quotas</a></li><li><a href=./test-imap>Test IMAP</a></li><li><a href=./smtp-auth>SMTP authentication</a></li><li><a href=./postfix-subm>Postfix submission server</a></li><li><a href=./forged-sender>Deny forged sender addresses</a></li><li><a href=./spf>Sender Policy Framework (SPF)</a></li><li><a href=./dkim>DomainKeys Identified Mail (DKIM)</a></li><li><a href=./dmarc>DMARC</a></li><li><a href=spf-dkim-chk>SPF and DKIM check</a></li><li><a href=block-spam>Optional — Block spam</a></li><li><a href=./tips>Tips</a></li></ol><p>Follow each step carefully to have a fully functional mail server.</p></div></div><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>