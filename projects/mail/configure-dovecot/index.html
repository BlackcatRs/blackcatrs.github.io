<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Configure Dovecot | Vithurshan SELVARAJAH</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/fonts/css/all.min.css><link rel=stylesheet href=/css/header-num.css><link rel=stylesheet href=/css/fonts.css></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/notes/>Notebook</a></li><li><a href=/categories/>Categories</a></li><li><a href=/projects/>Projects</a></li><li><a href=/index.xml>RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Configure Dovecot</span></h1><div class=post-meta><span> Published on 16 Feb 2025</span>
<span class=seperator>.</span>
<span> Filed in <a href=/projects>Projects</a></span>
<span class=seperator>.</span>
<span> 1109 words</span></div></div><main><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Configure Mailbox Owner</h2><div id=outline-text-headline-1 class=outline-text-2><p>First we need to create a new system user that will own all virtual mailboxes for security reasons. The following shell commands will create a system group <code class=verbatim>vmail</code> with group ID (GID) <code class=verbatim>5000</code> and a system user <code class=verbatim>vmail</code> with user ID (UID) <code class=verbatim>5000</code>. Make sure that UID and GID are not yet used or choose another – the number can be anything between 1000 and 65000 that is not yet used:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo groupadd -g <span style=color:#ae81ff>5000</span> vmail
</span></span><span style=display:flex><span>  sudo useradd -g vmail -u <span style=color:#ae81ff>5000</span> vmail -d /var/vmail -m
</span></span><span style=display:flex><span>  sudo chown -R vmail:vmail /var/vmail</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Prerequisites</h2><div id=outline-text-headline-2 class=outline-text-2><p>Make sure this line exist in the <code class=verbatim>/etc/dovecot/dovecot.conf</code>:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>!include conf.d/*.conf</span></span></code></pre></div></div></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Authentication Mechanism</h2><div id=outline-text-headline-3 class=outline-text-2><p>Edit <code class=verbatim>/etc/dovecot/conf.d/10-auth.conf</code> and add :</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>auth_mechanisms = plain login</span></span></code></pre></div></div><ul><li>You need to add the <code class=verbatim>login</code> mechanism if you have Outlook users.</li></ul><p>These two mechanisms would ask for a password without enforcing encryption. But by default, Dovecot sets <code class=verbatim>disable_plaintext_auth = yes</code> which ensures that authentication is only accepted over TLS-encrypted connections.</p><p>At the end of this file you will find various authentication backends that Dovecot ships with. By default it will use system users (those from the <code class=verbatim>/etc/passwd</code>). But we want to use the MariaDB database backend so go ahead and change this block to:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#!include auth-system.conf.ext
</span></span><span style=display:flex><span>!include auth-sql.conf.ext
</span></span><span style=display:flex><span>#!include auth-ldap.conf.ext
</span></span><span style=display:flex><span>#!include auth-passwdfile.conf.ext
</span></span><span style=display:flex><span>#!include auth-checkpassword.conf.ext
</span></span><span style=display:flex><span>#!include auth-static.conf.ext</span></span></code></pre></div></div></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Set Mailbox Locations</h2><div id=outline-text-headline-4 class=outline-text-2><p>Change the mail_location in <code class=verbatim>/etc/dovecot/conf.d/10-mail.conf</code> to:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mail_location = maildir:~/Maildir</span></span></code></pre></div></div><p>This is the directory where Dovecot will look for the emails of a specific user. The tilde character (<code class=verbatim>~</code>) means the user’s home directory. That does not make sense yet. But further down on this page we will tell Dovecot what the home directory is supposed to mean. For example <code class=verbatim>user1@example.org</code> will have his home directory in <code class=verbatim>/var/vmail/example1.org/user1</code>.</p><p><em>NOTE: Further down in the <code class=verbatim>10-mail.conf</code> file you will find sections defining the namespaces <sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup>. Those are folder structures that your email client sees when connecting to the mail server. If you use POP3 you can only access the <code class=verbatim>inbox</code> – which is where all incoming email is stored. Using the IMAP protocol you get access to a hierarchy of folders and subfolders. And you can even share folders between users. Or use a public folder that can be accessed by anyone – even anonymously. So IMAP is generally to be preferred.</em></p></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Service and Authentication Socket Configuration</h2><div id=outline-text-headline-5 class=outline-text-2><p>Edit the <code class=verbatim>/etc/dovecot/conf.d/10-master.conf</code> file which deals with typical service ports like IMAP or POP3.</p><p><em>NOTE: Don’t worry about the standard unencrypted TCP ports 110 (for POP3) and 143 (for IMAP). They can be kept activated. If a user connects to these ports they will have to issue a <code>STARTTLS</code> command to switch into encrypted mode before they are allowed to send their password. There is basically no difference between using an plaintext port like 110 for POP3 and then using STARTTLS – or connecting to the encrypted 995 port for POP3s (secure).</em></p><p>A change is needed in the <code class=verbatim>service auth {...}</code> section because we want Postfix to allow Dovecot as an authentication service. Add the following lines in the previously mentioned section:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Postfix smtp-auth
</span></span><span style=display:flex><span>unix_listener /var/spool/postfix/private/auth {
</span></span><span style=display:flex><span>  mode = 0660
</span></span><span style=display:flex><span>  user = postfix
</span></span><span style=display:flex><span>  group = postfix
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-2><h2 id=headline-6>Certificate</h2><div id=outline-text-headline-6 class=outline-text-2><p>Earlier in this guide we created both a key and a certificate file to encrypt the communication with POP3 and IMAPs between the users and your mail server.</p><p>Edit the file <code class=verbatim>/etc/dovecot/conf.d/10-ssl.conf</code> to configure the certificate and key file path:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>ssl_cert = &lt;/etc/letsencrypt/live/example1.com/fullchain.pem
</span></span><span style=display:flex><span>ssl_key = &lt;/etc/letsencrypt/live/example1.com/privkey.pem</span></span></code></pre></div></div><p>And enforce TLS encryption by setting:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  ssl = required</span></span></code></pre></div></div></div></div><div id=outline-container-headline-7 class=outline-2><h2 id=headline-7>User Authentication</h2><div id=outline-text-headline-7 class=outline-text-2><p>Dovecot reads the <code class=verbatim>/etc/dovecot/conf.d/auth-sql.conf.ext</code> which defines how to find user information in your database. There are two sections in this file:</p><ol><li><code class=verbatim>userdb</code>: where to find a user’s mailbox in the file system</li><li><code class=verbatim>passdb</code>: where to find the user’s hashed password</li></ol><p>By default Dovecot will run two queries at your database. One for the userdb that gets information like the user ID, group ID, home directory and quota. And another for the passdb that gets the hashed password.</p><p>The <code class=verbatim>userdb</code> section already reads:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>userdb {
</span></span><span style=display:flex><span>   driver = sql
</span></span><span style=display:flex><span>   args = /etc/dovecot/dovecot-sql.conf.ext
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>As you can see Dovecot uses an SQL database lookup to get that information. Edit the file <code class=verbatim>/etc/dovecot/dovecot-sql.conf.ext</code> for more information. You will find this file well documented although all configuration directives are commented out. Add these lines at the bottom of the file:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>driver = mysql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>connect = \
</span></span><span style=display:flex><span>  host=127.0.0.1 \
</span></span><span style=display:flex><span>  dbname=mailserver \
</span></span><span style=display:flex><span>  user=mailserver \
</span></span><span style=display:flex><span>  password=x893dNj4stkHy1MKQq0USWBaX4ZZdq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user_query = SELECT email as user, \
</span></span><span style=display:flex><span>  concat(&#39;*:bytes=&#39;, quota) AS quota_rule, \
</span></span><span style=display:flex><span>  &#39;/var/vmail/%d/%n&#39; AS home, \
</span></span><span style=display:flex><span>  5000 AS uid, 5000 AS gid \
</span></span><span style=display:flex><span>  FROM virtual_users WHERE email=&#39;%u&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>password_query = SELECT password FROM virtual_users WHERE email=&#39;%u&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iterate_query = SELECT email AS user FROM virtual_users</span></span></code></pre></div></div><p><em>NOTE: Ending a line with a backslash (<code class=verbatim>\</code>) means that it is continued on the next line. It keeps the configuration more readable.</em></p><p>What these lines mean:</p><ul><li><code class=verbatim>driver</code>: The kind of database. MariaDB is the same kind as MySQL.</li><li><code class=verbatim>connect</code>: Information to access MySQL database (username, password, etc…)</li><li><code class=verbatim>user_query</code>: An SQL query that returns the user name (the email address), the quota, the home directory, user ID and group ID.</li><li><code class=verbatim>password_query</code>: this SQL query just gets the password hash from the database</li><li><code class=verbatim>iterate_query</code>: "doveadm" uses this query to get a list of all users. That allows you to use the <code>doveadm user '*'</code> command later.</li></ul><p>The <code class=verbatim>user_query</code> gets several pieces of information from the database:</p><ul><li><code class=verbatim>email AS user</code>: It gets the the <code class=verbatim>email</code> field from the database which corresponds to the user name. Dovecot expects it in the user field so we set an alias to <code class=verbatim>user</code>.</li><li><code class=verbatim>userdb_quota_rule</code>: This is the user’s quota in bytes. It is the maximum space on disk that the user can occupy. As documented Dovecot expects the quota in a special format like <code class=verbatim>*:bytes=10000</code> if the user should not be able to store more than 10,000 bytes. That’s why we begin the string with <code class=verbatim>*:bytes=</code>.</li><li><code class=verbatim>userdb_home</code>: This leads to the directory where all emails and various control files for this user are located. The placeholder <code class=verbatim>%d</code> replaces the domain and <code class=verbatim>%n</code> the user part. So for <code class=verbatim>user1</code> that makes it <code class=verbatim>/var/vmail/example.org/user1</code>.</li><li><code class=verbatim>userdb_uid and userdb_gid</code>: Those are the user ID and group ID of vmail user – 5000 for both. Dovecot uses it to set the permissions of files it creates. As all users share the same system user <code class=verbatim>vmail</code> this is just a static number.</li></ul></div></div><div id=outline-container-headline-8 class=outline-2><h2 id=headline-8>Fix Permissions</h2><div id=outline-text-headline-8 class=outline-text-2><p>Make sure that only root can access the SQL configuration file so nobody else is reading your database access passwords:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sudo chown root:root /etc/dovecot/dovecot-sql.conf.ext
</span></span><span style=display:flex><span>sudo chmod go= /etc/dovecot/dovecot-sql.conf.ext</span></span></code></pre></div></div><p>Restart Dovecot:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo systemctl restart dovecot</span></span></code></pre></div></div><p>Look at your /var/log/mail.log logfile. You should see:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Dovecot v2.3.13 (f79e8e7e4) starting up for imap, lmtp, sieve, pop3 (core dumps disabled)</span></span></code></pre></div></div></div></div><div id=outline-container-headline-9 class=outline-2><h2 id=headline-9>Footnotes</h2></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>Namespaces - <a href=https://doc.dovecot.org/2.3/configuration_manual/namespace/>https://doc.dovecot.org/2.3/configuration_manual/namespace/</a></p></div></div></div></div></main><footer><hr>© <a href=https:www.atomicl.net>Vithurshan SELVARAJAH</a> 2022 – 2025 | <a href=https://github.com/BlackcatRs>Github</a> | <a href=https://www.linkedin.com/in/vithurshan-selvarajah/>LinkedIn</a></footer></body></html>